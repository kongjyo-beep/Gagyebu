<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<title>ì•„ì´í° ê°€ê³„ë¶€</title>
<meta name="apple-mobile-web-app-title" content="ë‚´ ê°€ê³„ë¶€">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.PNG">
<link rel="shortcut icon" href="icon.PNG">
<style>
    :root {
        --ios-bg: #F2F2F7;
        --ios-card: #FFFFFF;
        --ios-blue: #007AFF;
        --ios-red: #FF3B30;
        --ios-green: #34C759;
        --ios-gray-text: #8E8E93;
        --ios-border: #E5E5EA;
        --ios-black: #000000;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--ios-bg);
        margin: 0; padding: 0; color: var(--ios-black);
        -webkit-font-smoothing: antialiased; user-select: none; 
        /* í’€ìŠ¤í¬ë¦° ì‹œ í•˜ë‹¨ ì•ˆì „ì˜ì—­ í™•ë³´ */
        padding-bottom: env(safe-area-inset-bottom);
    }

    /* --- í—¤ë” --- */
    .header-card {
        background: var(--ios-card); 
        /* ìƒë‹¨ ìƒíƒœë°” ì•ˆì „ì˜ì—­ í™•ë³´ */
        padding: calc(env(safe-area-inset-top) + 20px) 20px 20px 20px;
        border-bottom-left-radius: 24px; border-bottom-right-radius: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 20px; position: relative;
    }

    /* ì‹¬í”Œí•œ ì„¤ì • ë²„íŠ¼ (SVG) - ìœ„ì¹˜ ì¡°ì • */
    .settings-btn {
        position: absolute; top: calc(env(safe-area-inset-top) + 20px); right: 20px;
        background: none; border: none; cursor: pointer; padding: 5px; opacity: 0.6;
    }
    .settings-btn svg { width: 22px; height: 22px; fill: var(--ios-gray-text); }

    .main-balance { text-align: center; margin-bottom: 25px; margin-top: 10px; }
    .header-label { font-size: 14px; color: var(--ios-gray-text); margin-bottom: 6px; }
    .balance-amount { font-size: 38px; font-weight: 700; letter-spacing: -0.5px; }

    /* ì„œë¸Œ ì •ë³´ */
    .sub-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
    .info-box {
        background: #F9F9F9; border-radius: 18px; padding: 15px; text-align: center;
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.03); transition: transform 0.1s; cursor: pointer;
    }
    .info-box:active { transform: scale(0.96); background: #f0f0f0; }
    .info-title { font-size: 12px; color: #888; margin-bottom: 6px; font-weight: 500; }
    .info-value { font-size: 17px; font-weight: 700; }
    
    .val-saving { color: var(--ios-blue); }
    .val-good { color: var(--ios-green); }
    .val-bad { color: var(--ios-red); }

    /* ë²„íŠ¼ ê·¸ë£¹ */
    .action-row { display: flex; gap: 10px; }
    .btn-main {
        flex: 1; padding: 14px; border-radius: 14px; border: none;
        font-size: 15px; font-weight: 600; color: white;
        background: var(--ios-blue); cursor: pointer; transition: opacity 0.2s;
        box-shadow: 0 2px 6px rgba(0,122,255,0.2);
    }
    .btn-main:active { opacity: 0.7; transform: scale(0.98); }
    .btn-income { background: var(--ios-green); box-shadow: 0 2px 6px rgba(52,199,89,0.2); }
    .btn-budget { background: white; color: var(--ios-blue); border: 1px solid var(--ios-blue); box-shadow: none; }

    /* --- ëª¨ë‹¬/í¼ --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.4); display: none; z-index: 1000;
        align-items: center; justify-content: center; backdrop-filter: blur(2px);
    }
    .modal-overlay.active { display: flex; }

    .input-group {
        background: white; width: 85%; max-width: 360px;
        padding: 24px; border-radius: 24px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        animation: popUp 0.25s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes popUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .form-row { margin-bottom: 16px; }
    .form-label { font-size: 13px; font-weight:600; color: #333; margin-bottom: 6px; display: block; }
    input, select {
        width: 100%; box-sizing: border-box; padding: 14px;
        border-radius: 12px; border: 1px solid #E5E5EA;
        font-size: 16px; background: #F2F2F7; -webkit-appearance: none;
    }
    input:focus, select:focus { background: white; border-color: var(--ios-blue); outline: none; }
    
    .hidden { display: none; }

    /* --- ë‹¬ë ¥ --- */
    .calendar-container {
        background: var(--ios-card); margin: 0 16px; border-radius: 20px;
        padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    .cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .cal-title { font-size: 18px; font-weight: 700; }
    .nav-btn { background: none; border: none; font-size: 16px; color: var(--ios-blue); padding: 5px; cursor: pointer;}
    .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: #999; margin-bottom: 10px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    
    .day-cell {
        height: 54px; display: flex; flex-direction: column; align-items: center;
        cursor: pointer; border-radius: 10px; position: relative; padding-top:6px;
    }
    .day-cell.today { background: rgba(0,122,255,0.08); }
    .day-cell.selected { border: 2px solid var(--ios-blue); }
    
    .day-num { font-size: 15px; font-weight: 500; margin-bottom: 4px; }
    .status-dot { width: 5px; height: 5px; border-radius: 50%; }
    .dot-green { background-color: var(--ios-green); }
    .dot-yellow { background-color: #FFCC00; }
    .dot-red { background-color: var(--ios-red); }
    
    .sun { color: var(--ios-red); } .sat { color: var(--ios-blue); }

    /* --- ë¦¬ìŠ¤íŠ¸ --- */
    .detail-section { margin: 24px 16px; }
    .list-header { font-size: 18px; font-weight:700; margin-bottom: 10px; margin-left: 5px; }
    .record-list { background: var(--ios-card); border-radius: 16px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
    .record-item {
        padding: 18px; border-bottom: 1px solid var(--ios-border);
        display: flex; justify-content: space-between; align-items: center;
    }
    .record-item:active { background: #f5f5f5; }
    .record-info { display: flex; flex-direction: column; gap: 4px; }
    .record-cat { font-size: 16px; font-weight: 500;}
    .record-meta { font-size: 12px; color: #999; display: flex; gap: 6px; align-items: center;}
    .tag-fixed { background: #E5E5EA; color: #333; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;}
    .tag-memo { color: #888; font-style: italic;}
    
    .amount-expense { color: var(--ios-black); font-weight:600; font-size: 16px; }
    .amount-income { color: var(--ios-green); font-weight:600; font-size: 16px; }
    .amount-saving { color: var(--ios-blue); font-weight:600; font-size: 16px; }

    /* --- ì•¡ì…˜ ì‹œíŠ¸/ì„¤ì • --- */
    .action-sheet-overlay {
        position: fixed; top:0; left:0; right:0; bottom:0;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: none; align-items: flex-end;
    }
    .action-sheet-overlay.active { display: flex; }
    .action-sheet {
        background: transparent; width: 100%; padding: 10px;
        box-sizing: border-box;
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    .sheet-btn {
        background: white; border: none; width: 100%; padding: 18px;
        font-size: 17px; color: var(--ios-blue); margin-bottom: 1px; cursor: pointer;
    }
    .sheet-btn:first-child { border-top-left-radius: 14px; border-top-right-radius: 14px; }
    .sheet-btn:last-child { border-bottom-left-radius: 14px; border-bottom-right-radius: 14px; margin-bottom: 8px; }
    .sheet-cancel { border-radius: 14px; font-weight: 600; background: white; }
    .sheet-delete { color: var(--ios-red); }

</style>
</head>
<body>

<div class="header-card">
    <button class="settings-btn" onclick="openSettings()">
        <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
    </button>
    <div class="main-balance">
        <div class="header-label">í˜„ì¬ ì”ê³ </div>
        <div class="balance-amount" id="balanceDisplay">0ì›</div>
    </div>

    <div class="sub-info-grid">
        <div class="info-box" id="boxSavings">
            <div class="info-title">ğŸ’° ì €ì¶• í†µì¥</div>
            <div class="info-value val-saving" id="savingsDisplay">0ì›</div>
        </div>
        <div class="info-box" id="boxSavingGoal">
            <div class="info-title">ğŸ‘ ì´ë²ˆ ë‹¬ ì•„ë‚€ ëˆ</div>
            <div class="info-value" id="accumulatedSaveDisplay">0ì›</div>
            <div style="font-size:10px; color:#aaa; margin-top:2px;" id="paydayLabel">ë§¤ì›” 1ì¼ ê¸°ì¤€</div>
        </div>
    </div>

    <div class="action-row">
        <button class="btn-main" onclick="openForm('expense')">ì§€ì¶œ ê¸°ë¡</button>
        <button class="btn-main btn-income" onclick="openForm('income')">ìˆ˜ì… ê¸°ë¡</button>
        <button class="btn-main btn-budget" onclick="openBudgetModal()">ì˜ˆì‚° ì„¤ì •</button>
    </div>
</div>

<div class="modal-overlay" id="formOverlay" onclick="closeForm(event)">
    <div class="input-group" id="inputForm">
        <h3 id="formTitle" style="margin:0 0 20px 0;">ë‚´ì—­ ì¶”ê°€</h3>
        
        <div class="form-row">
            <label class="form-label">ë‚ ì§œ</label>
            <input type="date" id="inputDate">
        </div>

        <div class="form-row">
            <label class="form-label">ìœ í˜•</label>
            <div style="display:flex; gap:10px;">
                <select id="inputType" onchange="handleTypeChange()" style="flex:1;">
                    <option value="expense">ì§€ì¶œ</option>
                    <option value="saving">ì €ì¶•</option>
                    <option value="income">ìˆ˜ì…</option>
                </select>
                <select id="expenseNature" class="hidden" style="flex:1; border-color:#007AFF; color:#007AFF; font-weight:600;">
                    <option value="variable">ë³€ë™ë¹„ (ì˜ˆì‚°ì°¨ê°)</option>
                    <option value="fixed">ê³ ì •ë¹„ (ì˜ˆì‚°ì œì™¸)</option>
                </select>
            </div>
        </div>

        <div class="form-row" id="categoryRow">
            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
            <select id="inputCategory" onchange="handleCategoryChange()">
                <option value="ì‹ë¹„">ì‹ë¹„</option>
                <option value="êµí†µ">êµí†µ</option>
                <option value="ì‡¼í•‘">ì‡¼í•‘</option>
                <option value="ì£¼ê±°">ì£¼ê±°/í†µì‹ </option>
                <option value="ì˜ë£Œ">ì˜ë£Œ/ê±´ê°•</option>
                <option value="ë¬¸í™”">ë¬¸í™”/ì—¬ê°€</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€ (ì§ì ‘ì…ë ¥)</option>
            </select>
            <input type="text" id="customCategory" class="hidden" placeholder="ì¹´í…Œê³ ë¦¬ëª… ì…ë ¥" style="margin-top:8px;">
        </div>

        <div class="form-row">
            <label class="form-label">ê¸ˆì•¡</label>
            <input type="text" id="inputAmount" placeholder="0" inputmode="numeric" onkeyup="formatCurrencyInput(this)">
        </div>
        
        <div class="form-row">
            <label class="form-label">ë©”ëª¨ (ì„ íƒ)</label>
            <input type="text" id="inputMemo" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <button class="btn-main" style="width:100%" onclick="saveRecord()">ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<div class="modal-overlay" id="initialSavingsOverlay" onclick="closeInitialSavingsModal(event)">
    <div class="input-group">
        <h3 style="margin:0 0 10px 0;">ì €ì¶• í†µì¥ ì„¤ì •</h3>
        <p style="font-size:13px; color:#888; margin-bottom:20px;">ì €ì¶• í†µì¥ì˜ <b>ê¸°ì´ˆ ì”ì•¡(ì‹œì‘ ê¸ˆì•¡)</b>ì„ ì…ë ¥í•˜ì„¸ìš”.<br>ê¸°ë¡ëœ ì €ì¶• ë‚´ì—­ì€ ì—¬ê¸°ì— ë”í•´ì§‘ë‹ˆë‹¤.</p>
        <div class="form-row">
            <input type="text" id="initialSavingsInput" placeholder="0" inputmode="numeric" onkeyup="formatCurrencyInput(this)" style="font-size:24px; text-align:center; font-weight:700;">
        </div>
        <button class="btn-main" style="width:100%" onclick="saveInitialSavings()">ì„¤ì • ì €ì¥</button>
    </div>
</div>


<div class="modal-overlay" id="budgetOverlay" onclick="closeBudgetModal(event)">
    <div class="input-group">
        <h3 style="margin:0 0 10px 0;">ìš”ì¼ë³„ ì˜ˆì‚° (ë³€ë™ë¹„)</h3>
        <p style="font-size:13px; color:#888; margin-bottom:15px;">ê³ ì •ë¹„ë¥¼ ì œì™¸í•œ í•˜ë£¨ ìƒí™œë¹„ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
            <div><label class="form-label" style="color:red">ì¼ìš”ì¼</label><input type="text" id="bg_0" inputmode="numeric" onkeyup="calcBudgetTotal()"></div>
            <div><label class="form-label">ì›”ìš”ì¼</label><input type="text" id="bg_1" inputmode="numeric" onkeyup="calcBudgetTotal()"></div>
            <div><label class="form-label">í™”ìš”ì¼</label><input type="text" id="bg_2" inputmode="numeric" onkeyup="calcBudgetTotal()"></div>
            <div><label class="form-label">ìˆ˜ìš”ì¼</label><input type="text" id="bg_3" inputmode="numeric" onkeyup="calcBudgetTotal()"></div>
            <div><label class="form-label">ëª©ìš”ì¼</label><input type="text" id="bg_4" inputmode="numeric" onkeyup="calcBudgetTotal()"></div>
            <div><label class="form-label">ê¸ˆìš”ì¼</label><input type="text" id="bg_5" inputmode="numeric" onkeyup="calcBudgetTotal()"></div>
            <div><label class="form-label" style="color:blue">í† ìš”ì¼</label><input type="text" id="bg_6" inputmode="numeric" onkeyup="calcBudgetTotal()"></div>
        </div>
        
        <div style="background:#F2F2F7; padding:15px; border-radius:12px; margin-bottom:15px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-size:13px; color:#666;">ì£¼ê°„ ì´ ì˜ˆì‚°</span>
                <span id="weeklyBudgetTotal" style="font-weight:600; font-size:14px;">0ì›</span>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span style="font-size:13px; color:#666;">ì›” ì˜ˆìƒ ë³€ë™ë¹„</span>
                <span id="monthlyBudgetTotal" style="font-weight:700; font-size:15px; color:var(--ios-blue);">0ì›</span>
            </div>
        </div>

        <button class="btn-main" style="width:100%;" onclick="saveBudgets()">ì €ì¥</button>
    </div>
</div>

<div class="action-sheet-overlay" id="settingsSheet" onclick="closeSettings(event)">
    <div class="action-sheet">
        <div style="border-radius:14px; overflow:hidden; margin-bottom:8px;">
            <div style="background:white; padding:15px; text-align:center; font-size:13px; color:#888; border-bottom:1px solid #E5E5EA;">
                ë°ì´í„° ê´€ë¦¬
            </div>
            <button class="sheet-btn sheet-delete" onclick="resetAllData()">âš ï¸ ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
        <button class="sheet-btn sheet-cancel" onclick="closeSettingsReal()">ë‹«ê¸°</button>
    </div>
</div>

<div class="action-sheet-overlay" id="actionSheet" onclick="closeActionSheet(event)">
    <div class="action-sheet">
        <div style="border-radius:14px; overflow:hidden; margin-bottom:8px;">
            <button class="sheet-btn" onclick="executeEdit()">ìˆ˜ì •í•˜ê¸°</button>
            <div style="height:1px; background:#E5E5EA;"></div>
            <button class="sheet-btn sheet-delete" onclick="executeDelete()">ì‚­ì œí•˜ê¸°</button>
        </div>
        <button class="sheet-btn sheet-cancel" onclick="closeActionSheetReal()">ì·¨ì†Œ</button>
    </div>
</div>

<div class="calendar-container">
    <div class="cal-nav">
        <button class="nav-btn" onclick="changeMonth(-1)">â—€ ì´ì „</button>
        <div class="cal-title" id="monthTitle"></div>
        <button class="nav-btn" onclick="changeMonth(1)">ë‹¤ìŒ â–¶</button>
    </div>
    <div class="weekdays">
        <div class="sun">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="sat">í† </div>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
</div>

<div class="detail-section">
    <div class="list-header" id="selectedDateTitle">ì˜¤ëŠ˜ì˜ ë‚´ì—­</div>
    <p style="font-size:13px; color:#aaa; margin-left:5px; margin-top:0;">ğŸ’¡ í•­ëª©ì„ ê¸¸ê²Œ ëˆ„ë¥´ë©´ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥</p>
    <div class="record-list" id="recordList"></div>
</div>

<script>
    // --- ì´ˆê¸° ë°ì´í„° ë¡œë“œ ---
    let balance = parseInt(localStorage.getItem("balance")) || 0;
    let initialSavings = parseInt(localStorage.getItem("initialSavings"));
    if (isNaN(initialSavings)) {
        initialSavings = parseInt(localStorage.getItem("savings")) || 0;
    }
    
    let payday = parseInt(localStorage.getItem("payday")) || 1; 
    let records = JSON.parse(localStorage.getItem("records")) || {};
    let budgets = JSON.parse(localStorage.getItem("dailyBudgets")) || [50000, 30000, 30000, 30000, 30000, 30000, 50000];

    let currentDate = new Date();
    let selectedDate = new Date();
    
    let targetKey = null;
    let targetIndex = null;
    let isEditing = false;

    // --- ì´ˆê¸° ì‹¤í–‰ ---
    document.addEventListener("DOMContentLoaded", () => {
        setupLongPress();
        updateDashboard();
        renderCalendar();
        showRecordsForDate(new Date());
    });

    // --- ìœ í‹¸ë¦¬í‹° ---
    function formatMoney(num) { return num.toLocaleString(); }
    
    function formatCurrencyInput(input) {
        let value = input.value.replace(/[^0-9]/g, '');
        if (value) {
            input.value = parseInt(value).toLocaleString();
        } else {
            input.value = "";
        }
        if(input.id.startsWith('bg_')) calcBudgetTotal();
    }
    
    function parseCurrency(str) { return parseInt(str.replace(/,/g, '')) || 0; }

    function getDateKey(dateObj) {
        const offset = dateObj.getTimezoneOffset() * 60000;
        return (new Date(dateObj - offset)).toISOString().slice(0, 10);
    }
    
    function saveData() {
        localStorage.setItem("balance", balance);
        localStorage.setItem("initialSavings", initialSavings);
        localStorage.setItem("payday", payday);
        localStorage.setItem("records", JSON.stringify(records));
        localStorage.setItem("dailyBudgets", JSON.stringify(budgets));
        updateDashboard();
        renderCalendar();
    }

    // --- ì„¤ì • & ì´ˆê¸°í™” ---
    function openSettings() { document.getElementById("settingsSheet").classList.add("active"); }
    function closeSettings(e) { if(e.target.id === "settingsSheet") closeSettingsReal(); }
    function closeSettingsReal() { document.getElementById("settingsSheet").classList.remove("active"); }
    
    function resetAllData() {
        if(confirm("ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
            localStorage.clear();
            location.reload();
        }
    }

    // --- ë¡±í”„ë ˆìŠ¤ ê¸°ëŠ¥ ---
    function setupLongPress() {
        // ì €ì¶• í†µì¥
        addLongPressEvent(document.getElementById("boxSavings"), () => {
            document.getElementById("initialSavingsOverlay").classList.add("active");
            document.getElementById("initialSavingsInput").value = initialSavings.toLocaleString();
            document.getElementById("initialSavingsInput").focus();
        });

        // ì•„ë‚€ ëˆ
        addLongPressEvent(document.getElementById("boxSavingGoal"), () => {
            let newPayday = prompt("ì´ë²ˆ ë‹¬ ì•„ë‚€ ëˆ ê³„ì‚° ê¸°ì¤€ì¼(ì›”ê¸‰ë‚ )ì„ ì…ë ¥í•˜ì„¸ìš” (1~31)", payday);
            if(newPayday !== null) {
                let parsed = parseInt(newPayday);
                if(parsed >= 1 && parsed <= 31) {
                    payday = parsed;
                    saveData();
                    alert(`ê¸°ì¤€ì¼ì´ ë§¤ì›” ${payday}ì¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } else {
                    alert("1ì—ì„œ 31 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                }
            }
        });
    }

    function addLongPressEvent(el, callback) {
        let timer;
        const start = () => { timer = setTimeout(() => { if(navigator.vibrate) navigator.vibrate(50); callback(); }, 800); };
        const end = () => clearTimeout(timer);
        el.addEventListener('touchstart', start);
        el.addEventListener('touchend', end);
        el.addEventListener('mousedown', start);
        el.addEventListener('mouseup', end);
    }

    // --- ì €ì¶• ê¸°ì´ˆ ì”ì•¡ ëª¨ë‹¬ ---
    function closeInitialSavingsModal(e) { if(e.target.id==="initialSavingsOverlay") document.getElementById("initialSavingsOverlay").classList.remove("active"); }
    function saveInitialSavings() {
        let val = parseCurrency(document.getElementById("initialSavingsInput").value);
        initialSavings = val;
        saveData();
        document.getElementById("initialSavingsOverlay").classList.remove("active");
    }

    // --- ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ---
    function updateDashboard() {
        document.getElementById("balanceDisplay").innerText = formatMoney(balance) + "ì›";
        
        // ì €ì¶• ì´ì•¡ = ê¸°ì´ˆ ì”ì•¡ + ê¸°ë¡ëœ ì €ì¶• í•©ê³„
        let totalRecordedSavings = 0;
        Object.values(records).flat().forEach(r => {
            if(r.type === 'saving') totalRecordedSavings += r.amount;
        });
        document.getElementById("savingsDisplay").innerText = formatMoney(initialSavings + totalRecordedSavings) + "ì›";
        
        document.getElementById("paydayLabel").innerText = `ë§¤ì›” ${payday}ì¼ ê¸°ì¤€`;

        // ì•„ë‚€ ëˆ ê³„ì‚° (ê³ ì •ë¹„ ì œì™¸)
        let today = new Date();
        let startYear = today.getFullYear();
        let startMonth = today.getMonth();
        
        if (today.getDate() < payday) { startMonth = startMonth - 1; }
        
        let accumulatedSaved = 0;
        let loopDate = new Date(startYear, startMonth, payday);
        
        while(loopDate <= today) {
            let key = getDateKey(loopDate);
            let dayOfWeek = loopDate.getDay();
            let dailyBudget = budgets[dayOfWeek];
            
            let dailyVariableExpense = 0;
            if(records[key]){
                records[key].forEach(r => {
                    if(r.type === 'expense' && r.nature !== 'fixed') {
                        dailyVariableExpense += r.amount;
                    }
                });
            }
            accumulatedSaved += (dailyBudget - dailyVariableExpense);
            loopDate.setDate(loopDate.getDate() + 1);
        }

        let saveEl = document.getElementById("accumulatedSaveDisplay");
        if(accumulatedSaved >= 0) {
            saveEl.innerText = "+" + formatMoney(accumulatedSaved) + "ì›";
            saveEl.className = "info-value val-good";
        } else {
            saveEl.innerText = formatMoney(accumulatedSaved) + "ì›";
            saveEl.className = "info-value val-bad";
        }
    }

    // --- í¼ ê´€ë¦¬ ---
    function openForm(mode, record=null) {
        document.getElementById("formOverlay").classList.add("active");
        const typeSelect = document.getElementById("inputType");
        const catRow = document.getElementById("categoryRow");
        const natureSelect = document.getElementById("expenseNature");
        const memoInput = document.getElementById("inputMemo");

        if(record) { // ìˆ˜ì •
            document.getElementById("formTitle").innerText = "ë‚´ì—­ ìˆ˜ì •";
            document.getElementById("inputDate").value = targetKey;
            document.getElementById("inputAmount").value = record.amount.toLocaleString();
            memoInput.value = record.memo || "";
            
            typeSelect.innerHTML = `<option value="expense">ì§€ì¶œ</option><option value="saving">ì €ì¶•</option><option value="income">ìˆ˜ì…</option>`;
            typeSelect.value = record.type;

            if(record.type === 'expense') {
                catRow.classList.remove("hidden");
                natureSelect.classList.remove("hidden");
                natureSelect.value = record.nature || 'variable';
                
                const basic = ["ì‹ë¹„","êµí†µ","ì‡¼í•‘","ì£¼ê±°","ì˜ë£Œ","ë¬¸í™”"];
                if(basic.includes(record.category)){
                    document.getElementById("inputCategory").value = record.category;
                    document.getElementById("customCategory").classList.add("hidden");
                } else {
                    document.getElementById("inputCategory").value = "ê¸°íƒ€";
                    document.getElementById("customCategory").classList.remove("hidden");
                    document.getElementById("customCategory").value = record.category;
                }
            } else {
                catRow.classList.add("hidden");
                natureSelect.classList.add("hidden");
            }
        } else { // ì‹ ê·œ
            isEditing = false;
            document.getElementById("formTitle").innerText = "ë‚´ì—­ ì¶”ê°€";
            document.getElementById("inputDate").valueAsDate = selectedDate;
            document.getElementById("inputAmount").value = "";
            document.getElementById("customCategory").value = "";
            memoInput.value = "";
            
            typeSelect.innerHTML = "";
            if(mode === 'expense') {
                typeSelect.add(new Option("ì§€ì¶œ", "expense"));
                typeSelect.add(new Option("ì €ì¶•", "saving"));
                catRow.classList.remove("hidden");
                natureSelect.classList.remove("hidden");
                natureSelect.value = 'variable';
            } else {
                typeSelect.add(new Option("ìˆ˜ì…", "income"));
                catRow.classList.add("hidden");
                natureSelect.classList.add("hidden");
            }
        }
    }

    function handleTypeChange() {
        let type = document.getElementById("inputType").value;
        let catRow = document.getElementById("categoryRow");
        let natureSelect = document.getElementById("expenseNature");
        
        if(type === 'expense') {
            catRow.classList.remove("hidden");
            natureSelect.classList.remove("hidden");
        } else {
            catRow.classList.add("hidden");
            natureSelect.classList.add("hidden");
        }
    }

    function handleCategoryChange() {
        if(document.getElementById("inputCategory").value === "ê¸°íƒ€") {
            document.getElementById("customCategory").classList.remove("hidden");
        } else {
            document.getElementById("customCategory").classList.add("hidden");
        }
    }

    function closeForm(e) { if(e.target.id==="formOverlay") document.getElementById("formOverlay").classList.remove("active"); }
    function closeFormReal() { document.getElementById("formOverlay").classList.remove("active"); }

    function saveRecord() {
        let dateVal = document.getElementById("inputDate").value;
        let type = document.getElementById("inputType").value;
        let amount = parseCurrency(document.getElementById("inputAmount").value);
        let memo = document.getElementById("inputMemo").value;
        let category = "-";
        let nature = "variable";

        if(!dateVal || amount === 0) { alert("ë‚ ì§œì™€ ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”."); return; }

        if(type === 'expense') {
            let catSelect = document.getElementById("inputCategory").value;
            category = (catSelect === 'ê¸°íƒ€') ? (document.getElementById("customCategory").value || 'ê¸°íƒ€') : catSelect;
            nature = document.getElementById("expenseNature").value;
        } else if(type === 'saving') {
            category = "ì €ì¶•";
        } else {
            category = "ìˆ˜ì…";
        }

        if(isEditing) {
            let oldR = records[targetKey][targetIndex];
            if(oldR.type === 'income') balance -= oldR.amount;
            else if(oldR.type === 'saving') balance += oldR.amount; 
            else balance += oldR.amount; 
            
            records[targetKey].splice(targetIndex, 1);
            if(records[targetKey].length === 0) delete records[targetKey];
        }

        if(!records[dateVal]) records[dateVal] = [];
        records[dateVal].push({ type, amount, category, memo, nature });

        if(type === 'income') balance += amount;
        else balance -= amount; 

        saveData();
        closeFormReal();
        
        selectedDate = new Date(dateVal);
        renderCalendar(); 
        showRecordsForDate(selectedDate);
    }

    // --- ì•¡ì…˜ ì‹œíŠ¸ ---
    function openActionSheet(key, index, record) {
        targetKey = key;
        targetIndex = index;
        document.getElementById("actionSheet").classList.add("active");
    }
    function closeActionSheet(e) { if(e.target.id === "actionSheet") closeActionSheetReal(); }
    function closeActionSheetReal() { document.getElementById("actionSheet").classList.remove("active"); }

    function executeEdit() {
        closeActionSheetReal();
        isEditing = true;
        let record = records[targetKey][targetIndex];
        openForm(null, record);
    }

    function executeDelete() {
        if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì”ê³ ë„ ë³µêµ¬ë©ë‹ˆë‹¤.")) return;
        
        let record = records[targetKey][targetIndex];
        
        if(record.type === 'income') balance -= record.amount;
        else if(record.type === 'saving') balance += record.amount;
        else balance += record.amount;

        records[targetKey].splice(targetIndex, 1);
        if(records[targetKey].length === 0) delete records[targetKey];

        saveData();
        closeActionSheetReal();
        showRecordsForDate(new Date(targetKey));
    }

    // --- ì˜ˆì‚° ì„¤ì • ---
    function openBudgetModal() {
        document.getElementById("budgetOverlay").classList.add("active");
        for(let i=0; i<7; i++) {
            document.getElementById(`bg_${i}`).value = budgets[i].toLocaleString();
        }
        calcBudgetTotal();
    }
    
    function calcBudgetTotal() {
        let weekly = 0;
        for(let i=0; i<7; i++) {
            weekly += parseCurrency(document.getElementById(`bg_${i}`).value);
        }
        document.getElementById("weeklyBudgetTotal").innerText = formatMoney(weekly) + "ì›";
        document.getElementById("monthlyBudgetTotal").innerText = "ì•½ " + formatMoney(Math.floor(weekly * 4.3)) + "ì›";
    }
    
    function closeBudgetModal(e) { if(e.target.id==="budgetOverlay") document.getElementById("budgetOverlay").classList.remove("active"); }
    function saveBudgets() {
        for(let i=0; i<7; i++) {
            budgets[i] = parseCurrency(document.getElementById(`bg_${i}`).value);
        }
        saveData();
        document.getElementById("budgetOverlay").classList.remove("active");
        alert("ì˜ˆì‚°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // --- ë‹¬ë ¥ UI ---
    function renderCalendar() {
        let year = currentDate.getFullYear();
        let month = currentDate.getMonth();
        document.getElementById("monthTitle").innerText = `${year}ë…„ ${month+1}ì›”`;
        
        let grid = document.getElementById("calendarGrid");
        grid.innerHTML = "";
        
        let firstDay = new Date(year, month, 1).getDay();
        let lastDate = new Date(year, month+1, 0).getDate();

        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement("div"));

        for(let d=1; d<=lastDate; d++){
            let dateObj = new Date(year, month, d);
            let key = getDateKey(dateObj);
            let dayOfWeek = dateObj.getDay();
            
            let el = document.createElement("div");
            el.className = "day-cell";
            
            let todayKey = getDateKey(new Date());
            if(key === todayKey) el.classList.add("today");
            if(key === getDateKey(selectedDate)) el.classList.add("selected");
            
            el.innerHTML = `<div class="day-num" style="color:${dayOfWeek===0?'var(--ios-red)':(dayOfWeek===6?'var(--ios-blue)':'black')}">${d}</div>`;
            
            let dailyExp = 0;
            if(records[key]) records[key].forEach(r => { 
                if(r.type==='expense' && r.nature !== 'fixed') dailyExp+=r.amount; 
            });
            
            if(dailyExp > 0) {
                let limit = budgets[dayOfWeek];
                let dot = document.createElement("div");
                dot.className = "status-dot";
                if(dailyExp > limit) dot.classList.add("dot-red");
                else if(dailyExp === limit) dot.classList.add("dot-yellow");
                else dot.classList.add("dot-green");
                el.appendChild(dot);
            }
            
            el.onclick = () => {
                selectedDate = new Date(year, month, d);
                renderCalendar();
                showRecordsForDate(selectedDate);
            };
            grid.appendChild(el);
        }
    }

    function changeMonth(n) { currentDate.setMonth(currentDate.getMonth()+n); renderCalendar(); }

    function showRecordsForDate(dateObj) {
        let key = getDateKey(dateObj);
        document.getElementById("selectedDateTitle").innerText = `${dateObj.getMonth()+1}ì›” ${dateObj.getDate()}ì¼ ë‚´ì—­`;
        let list = document.getElementById("recordList");
        list.innerHTML = "";
        
        let dayRecords = records[key] || [];
        if(dayRecords.length === 0) {
            list.innerHTML = `<div style="padding:40px; text-align:center; color:#ccc;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            return;
        }

        dayRecords.forEach((r, idx) => {
            let div = document.createElement("div");
            div.className = "record-item";
            
            let amountClass = 'amount-expense';
            let sign = '-';
            let catText = r.category;
            let metaHtml = "";

            if(r.type === 'income') { 
                amountClass='amount-income'; sign='+'; catText="ìˆ˜ì…"; 
            }
            else if(r.type === 'saving') { 
                amountClass='amount-saving'; sign='-'; catText="ì €ì¶•"; 
            }
            else {
                if(r.nature === 'fixed') metaHtml += `<span class="tag-fixed">ê³ ì •ë¹„</span>`;
                else metaHtml += `<span style="font-size:12px; color:#999;">ë³€ë™ë¹„</span>`;
            }

            if(r.memo) metaHtml += ` <span class="tag-memo">"${r.memo}"</span>`;
            
            div.innerHTML = `
                <div class="record-info">
                    <div class="record-cat">${catText}</div>
                    <div class="record-meta">${metaHtml}</div>
                </div>
                <div class="${amountClass}">${sign}${formatMoney(r.amount)}ì›</div>
            `;
            
            addLongPressEvent(div, () => openActionSheet(key, idx, r));
            
            list.appendChild(div);
        });
    }
</script>
</body>
</html>
