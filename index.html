<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<title>ê°€ê³„ë¶€ì¨ì£ </title>
<meta name="apple-mobile-web-app-title" content="ê°€ê³„ë¶€ì¨ì£ ">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.PNG">
<link rel="shortcut icon" href="icon.PNG">

<style>
    :root {
        --ios-bg: #F2F2F7;
        --ios-card: #FFFFFF;
        --ios-blue: #007AFF;
        --ios-red: #FF3B30;
        --ios-green: #34C759;
        --ios-yellow: #FFCC00;
        --ios-indigo: #5856D6;
        --ios-gray-text: #8E8E93;
        --ios-border: #E5E5EA;
        --ios-black: #000000;
        --safe-bottom: env(safe-area-inset-bottom);
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--ios-bg);
        margin: 0; padding: 0; color: var(--ios-black);
        -webkit-font-smoothing: antialiased; user-select: none; 
        padding-bottom: calc(70px + var(--safe-bottom)); /* íƒ­ë°” ê³µê°„ */
    }

    /* --- ë ˆì´ì•„ì›ƒ --- */
    .view-container { display: none; animation: fadeIn 0.2s; }
    .view-container.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- í—¤ë” (ì»´íŒ©íŠ¸ ìˆ˜ì •) --- */
    .header-card {
        background: var(--ios-card); 
        /* ìƒë‹¨ ì—¬ë°± ìµœì†Œí™” */
        padding: calc(env(safe-area-inset-top) + 15px) 16px 20px 16px;
        border-bottom-left-radius: 24px; border-bottom-right-radius: 24px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        margin-bottom: 15px; /* ì•„ë˜ ì¹´ë“œì™€ ê°„ê²© ì¤„ì„ */
        position: relative;
    }

    .settings-btn {
        position: absolute; top: calc(env(safe-area-inset-top) + 15px); right: 15px;
        background: none; border: none; cursor: pointer; padding: 5px; opacity: 0.5;
    }
    .settings-btn svg { width: 22px; height: 22px; fill: var(--ios-gray-text); }

    .main-balance { text-align: center; margin-bottom: 15px; margin-top: 5px; } /* ê°„ê²© ì¤„ì„ */
    .header-label { font-size: 13px; color: var(--ios-gray-text); margin-bottom: 2px; }
    .balance-amount { font-size: 36px; font-weight: 700; letter-spacing: -0.5px; } /* í°íŠ¸ ì‚´ì§ ì¡°ì • */
    .expected-balance { font-size: 12px; color: var(--ios-indigo); font-weight: 500; margin-top: 2px; }

    /* ì„œë¸Œ ì •ë³´ (ì»´íŒ©íŠ¸) */
    .sub-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .info-box {
        background: #F9F9F9; border-radius: 16px; padding: 12px; text-align: center; /* íŒ¨ë”© ì¤„ì„ */
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.03); transition: transform 0.1s; cursor: pointer;
    }
    .info-box:active { transform: scale(0.96); background: #f0f0f0; }
    .info-title { font-size: 11px; color: #888; margin-bottom: 4px; font-weight: 600; }
    .info-value { font-size: 16px; font-weight: 700; }
    
    .val-saving { color: var(--ios-blue); }
    .val-good { color: var(--ios-green); }
    .val-bad { color: var(--ios-red); }

    /* ë²„íŠ¼ ê·¸ë£¹ (ì»´íŒ©íŠ¸) */
    .action-row { display: flex; gap: 8px; margin-top: 0; }
    .btn-main {
        flex: 1; padding: 12px 0; /* ë†’ì´ ì¤„ì„ */
        border-radius: 14px; border: none;
        font-size: 14px; font-weight: 600; color: white;
        background: var(--ios-blue); cursor: pointer; transition: opacity 0.2s;
        box-shadow: 0 2px 5px rgba(0,122,255,0.2);
    }
    .btn-main:active { opacity: 0.7; transform: scale(0.98); }
    .btn-income { background: var(--ios-green); box-shadow: 0 2px 5px rgba(52,199,89,0.2); }
    .btn-budget { background: white; color: var(--ios-blue); border: 1px solid var(--ios-blue); box-shadow: none; }

    /* --- ëª¨ë‹¬/í¼ --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.4); display: none; z-index: 2000;
        align-items: center; justify-content: center; backdrop-filter: blur(2px);
    }
    .modal-overlay.active { display: flex; }

    .input-group {
        background: white; width: 85%; max-width: 360px;
        padding: 24px; border-radius: 24px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        animation: popUp 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        max-height: 85vh; overflow-y: auto;
    }
    @keyframes popUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .form-row { margin-bottom: 14px; }
    .form-label { font-size: 12px; font-weight:600; color: #333; margin-bottom: 6px; display: block; }
    input, select {
        width: 100%; box-sizing: border-box; padding: 12px;
        border-radius: 12px; border: 1px solid #E5E5EA;
        font-size: 16px; background: #F2F2F7; -webkit-appearance: none;
    }
    input:focus, select:focus { background: white; border-color: var(--ios-blue); outline: none; }
    .hidden { display: none; }

    /* --- ë‹¬ë ¥ (ì»´íŒ©íŠ¸) --- */
    .calendar-container {
        background: var(--ios-card); margin: 0 16px; border-radius: 20px;
        padding: 16px; /* íŒ¨ë”© ì¤„ì„ */
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    .cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .cal-title { font-size: 18px; font-weight: 700; }
    .nav-btn { 
        background: #F2F2F7; border: none; width: 32px; height: 32px; border-radius: 50%;
        font-size: 14px; color: var(--ios-blue); cursor: pointer; display: flex; align-items: center; justify-content: center;
    }

    .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: #999; margin-bottom: 8px; font-weight: 600; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    
    .day-cell {
        height: 52px; /* ë†’ì´ ì¤„ì„ */
        display: flex; flex-direction: column; align-items: center;
        cursor: pointer; border-radius: 10px; position: relative; padding-top:4px;
    }
    .day-cell.today { background: rgba(0,122,255,0.08); }
    .day-cell.selected { border: 2px solid var(--ios-blue); }
    
    .day-num { font-size: 15px; font-weight: 500; margin-bottom: 3px; }
    
    .dots-wrapper { display: flex; gap: 2px; }
    .status-dot { width: 4px; height: 4px; border-radius: 50%; } /* ì  í¬ê¸° ì¡°ì • */
    .dot-green { background-color: var(--ios-green); }
    .dot-yellow { background-color: var(--ios-yellow); }
    .dot-red { background-color: var(--ios-red); }
    .dot-blue { background-color: var(--ios-blue); }
    
    .sun { color: var(--ios-red); } .sat { color: var(--ios-blue); }

    /* ë²”ë¡€ (ì»´íŒ©íŠ¸) */
    .legend-row {
        display: flex; justify-content: center; gap: 12px; margin-top: 15px;
        padding-top: 10px; border-top: 1px solid #f0f0f0;
    }
    .legend-item { display: flex; align-items: center; gap: 4px; font-size: 10px; color: #888; }

    /* --- ë¦¬ìŠ¤íŠ¸ (ì»´íŒ©íŠ¸) --- */
    .detail-section { margin: 16px 16px; } /* ë§ˆì§„ ì¤„ì„ */
    .list-header { font-size: 16px; font-weight:700; margin-bottom: 8px; margin-left: 5px; }
    .record-list { background: var(--ios-card); border-radius: 16px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
    .record-item {
        padding: 14px 16px; /* íŒ¨ë”© ì¤„ì„ */
        border-bottom: 1px solid var(--ios-border);
        display: flex; justify-content: space-between; align-items: center;
    }
    .record-item:active { background: #f5f5f5; }
    .record-info { display: flex; flex-direction: column; gap: 2px; }
    .record-cat { font-size: 15px; font-weight: 600;}
    .record-meta { font-size: 11px; color: #999; display: flex; gap: 4px; align-items: center;}
    .tag-fixed { background: #E5E5EA; color: #333; padding: 2px 5px; border-radius: 4px; font-size: 10px; font-weight: 600;}
    .tag-memo { color: #888; font-style: italic;}
    
    .amount-expense { color: var(--ios-black); font-weight:600; font-size: 15px; }
    .amount-income { color: var(--ios-blue); font-weight:600; font-size: 15px; }
    .amount-saving { color: var(--ios-green); font-weight:600; font-size: 15px; }

    /* --- í†µê³„ í˜ì´ì§€ --- */
    .stats-card { background: white; border-radius: 16px; padding: 16px; margin: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
    .stats-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; }
    .chart-bar-container { display: flex; flex-direction: column; gap: 8px; }
    .chart-row { display: flex; align-items: center; gap: 8px; font-size: 12px; }
    .chart-label { width: 50px; color: #666; }
    .chart-bar-bg { flex: 1; background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden; }
    .chart-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
    .chart-value { width: 60px; text-align: right; font-weight: 600; }

    /* --- í•˜ë‹¨ íƒ­ë°” (ì»´íŒ©íŠ¸) --- */
    .tab-bar {
        position: fixed; bottom: 0; left: 0; right: 0;
        background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
        border-top: 1px solid #E5E5EA;
        display: flex; justify-content: space-around;
        padding-bottom: var(--safe-bottom);
        height: 55px; z-index: 100; /* ë†’ì´ ì•½ê°„ ì¤„ì„ */
    }
    .tab-item {
        flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: #999; font-size: 10px; font-weight: 500; cursor: pointer;
    }
    .tab-item.active { color: var(--ios-blue); }
    .tab-icon { font-size: 22px; margin-bottom: 2px; }

    /* --- í‘¸í„° --- */
    .footer-copy { text-align: center; color: #ccc; font-size: 10px; margin-top: 20px; margin-bottom: 80px;}

    /* ì•¡ì…˜ ì‹œíŠ¸ ë“± */
    .action-sheet-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: flex-end; }
    .action-sheet-overlay.active { display: flex; }
    .action-sheet { background: transparent; width: 100%; padding: 10px; box-sizing: border-box; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .sheet-btn { background: white; border: none; width: 100%; padding: 16px; font-size: 16px; color: var(--ios-blue); margin-bottom: 1px; cursor: pointer; }
    .sheet-btn:first-child { border-top-left-radius: 14px; border-top-right-radius: 14px; }
    .sheet-btn:last-child { border-bottom-left-radius: 14px; border-bottom-right-radius: 14px; margin-bottom: 8px; }
    .sheet-cancel { border-radius: 14px; font-weight: 600; background: white; }
    .sheet-delete { color: var(--ios-red); }

</style>
</head>
<body>

<div id="page-home" class="view-container active">
    <div class="header-card">
        <button class="settings-btn" onclick="openSettings()">
            <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
        </button>
        <div class="main-balance">
            <div class="header-label">í˜„ì¬ ì”ê³ </div>
            <div class="balance-amount" id="balanceDisplay">0ì›</div>
            <div class="expected-balance" id="expectedBalanceDisplay">(ì˜ˆìƒ ì”ì•¡: 0ì›)</div>
        </div>

        <div class="sub-info-grid">
            <div class="info-box" id="boxSavings">
                <div class="info-title">ğŸ’° ì €ì¶• í†µì¥</div>
                <div class="info-value val-saving" id="savingsDisplay">0ì›</div>
            </div>
            <div class="info-box" id="boxSavingGoal">
                <div class="info-title">ğŸ‘ ì´ë²ˆ ë‹¬ ì•„ë‚€ ëˆ</div>
                <div class="info-value" id="accumulatedSaveDisplay">0ì›</div>
            </div>
        </div>

        <div class="action-row">
            <button class="btn-main" onclick="openForm('expense')">ì§€ì¶œ</button>
            <button class="btn-main btn-income" onclick="openForm('income')">ìˆ˜ì…</button>
            <button class="btn-main btn-budget" onclick="openBudgetModal()">ì˜ˆì‚°</button>
        </div>
    </div>

    <div class="calendar-container">
        <div class="cal-nav">
            <button class="nav-btn" onclick="changeMonth(-1)">â—€</button>
            <div class="cal-title" id="monthTitle"></div>
            <button class="nav-btn" onclick="changeMonth(1)">â–¶</button>
        </div>
        <div class="weekdays">
            <div class="sun">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="sat">í† </div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
        
        <div class="legend-row">
            <div class="legend-item"><div class="status-dot dot-red"></div>ì´ˆê³¼</div>
            <div class="legend-item"><div class="status-dot dot-yellow"></div>ì£¼ì˜</div>
            <div class="legend-item"><div class="status-dot dot-green"></div>ì„±ê³µ</div>
            <div class="legend-item"><div class="status-dot dot-blue"></div>ìˆ˜ì…</div>
        </div>
    </div>

    <div class="detail-section">
        <div class="list-header" id="selectedDateTitle">ì˜¤ëŠ˜ì˜ ë‚´ì—­</div>
        <div class="record-list" id="recordList"></div>
    </div>
</div>

<div id="page-stats" class="view-container">
    <h2 style="padding:20px 20px 0 20px; margin:0; font-size:22px;">ì´ë²ˆ ë‹¬ í†µê³„</h2>
    
    <div class="stats-card">
        <div class="stats-title">ìˆ˜ì… ë° ì§€ì¶œ</div>
        <div class="chart-bar-container" id="statIncomeExpense">
            </div>
    </div>

    <div class="stats-card">
        <div class="stats-title">ì €ì¶• í˜„í™©</div>
        <div class="chart-bar-container" id="statSavings"></div>
    </div>
</div>

<div class="tab-bar">
    <div class="tab-item active" onclick="switchTab('home')">
        <div class="tab-icon">ğŸ </div>
        <div>ê°€ê³„ë¶€</div>
    </div>
    <div class="tab-item" onclick="switchTab('stats')">
        <div class="tab-icon">ğŸ“Š</div>
        <div>í†µê³„</div>
    </div>
</div>

<div class="footer-copy">Made by Jyo<br>Â© 2026 Gagyebu Project</div>

<div class="modal-overlay" id="formOverlay" onclick="closeForm(event)">
    <div class="input-group" id="inputForm">
        <h3 id="formTitle" style="margin:0 0 20px 0;">ë‚´ì—­ ì¶”ê°€</h3>
        <div class="form-row"><label class="form-label">ë‚ ì§œ</label><input type="date" id="inputDate"></div>
        <div class="form-row">
            <label class="form-label">ìœ í˜•</label>
            <div style="display:flex; gap:10px;">
                <select id="inputType" onchange="handleTypeChange()" style="flex:1;">
                    <option value="expense">ì§€ì¶œ</option>
                    <option value="saving">ì €ì¶•</option>
                    <option value="withdraw_saving">ì €ì¶• ì¶œê¸ˆ (ê¹¨ê¸°)</option>
                    <option value="income">ìˆ˜ì…</option>
                </select>
                <select id="expenseNature" class="hidden" style="flex:1; border-color:#007AFF; color:#007AFF; font-weight:600;">
                    <option value="variable">ë³€ë™ë¹„</option>
                    <option value="fixed">ê³ ì •ë¹„</option>
                </select>
            </div>
        </div>
        <div class="form-row" id="categoryRow">
            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
            <select id="inputCategory" onchange="handleCategoryChange()">
                <option value="ì‹ë¹„">ì‹ë¹„</option><option value="êµí†µ">êµí†µ</option><option value="ì‡¼í•‘">ì‡¼í•‘</option>
                <option value="ì£¼ê±°">ì£¼ê±°/í†µì‹ </option><option value="ì˜ë£Œ">ì˜ë£Œ/ê±´ê°•</option><option value="ë¬¸í™”">ë¬¸í™”/ì—¬ê°€</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€ (ì§ì ‘ì…ë ¥)</option>
            </select>
            <input type="text" id="customCategory" class="hidden" placeholder="ì¹´í…Œê³ ë¦¬ëª… ì…ë ¥" style="margin-top:8px;">
        </div>
        <div class="form-row"><label class="form-label">ê¸ˆì•¡</label><input type="text" id="inputAmount" placeholder="0" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
        <div class="form-row"><label class="form-label">ë©”ëª¨</label><input type="text" id="inputMemo" placeholder="ë‚´ìš© ì…ë ¥"></div>
        <button class="btn-main" style="width:100%" onclick="saveRecord()">ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<div class="modal-overlay" id="initialSavingsOverlay" onclick="closeInitialSavingsModal(event)">
    <div class="input-group">
        <h3>ì €ì¶• í†µì¥ ì„¤ì •</h3>
        <p style="font-size:13px; color:#888;">ê¸°ì´ˆ ì”ì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
        <input type="text" id="initialSavingsInput" inputmode="numeric" onkeyup="formatCurrencyInput(this)" style="font-size:24px; text-align:center;">
        <button class="btn-main" style="width:100%; margin-top:20px;" onclick="saveInitialSavings()">ì €ì¥</button>
    </div>
</div>

<div class="modal-overlay" id="budgetOverlay" onclick="closeBudgetModal(event)">
    <div class="input-group">
        <h3>ìš”ì¼ë³„ ì˜ˆì‚°</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
            <div><label class="form-label" style="color:red">ì¼</label><input type="text" id="bg_0" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
            <div><label class="form-label">ì›”</label><input type="text" id="bg_1" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
            <div><label class="form-label">í™”</label><input type="text" id="bg_2" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
            <div><label class="form-label">ìˆ˜</label><input type="text" id="bg_3" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
            <div><label class="form-label">ëª©</label><input type="text" id="bg_4" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
            <div><label class="form-label">ê¸ˆ</label><input type="text" id="bg_5" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
            <div><label class="form-label" style="color:blue">í† </label><input type="text" id="bg_6" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
        </div>
        <div style="background:#F2F2F7; padding:15px; border-radius:12px; margin-bottom:15px;">
            <div style="display:flex; justify-content:space-between;"><span>ì£¼ê°„ ì´ ì˜ˆì‚°</span><span id="weeklyBudgetTotal" style="font-weight:600;">0ì›</span></div>
        </div>
        <button class="btn-main" style="width:100%;" onclick="saveBudgets()">ì €ì¥</button>
    </div>
</div>

<div class="modal-overlay" id="fixedExpenseOverlay" onclick="closeFixedModal(event)">
    <div class="input-group">
        <h3>ê³ ì • ì§€ì¶œ ì„¤ì •</h3>
        <p style="font-size:13px; color:#888;">ë§¤ë‹¬ ìë™ìœ¼ë¡œ ë¹ ì ¸ë‚˜ê°ˆ ê³ ì •ë¹„ë¥¼ ë“±ë¡í•˜ì„¸ìš”.<br>(í•´ë‹¹ ë‚ ì§œì— ì•±ì„ ì¼œë©´ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤)</p>
        <div id="fixedList" style="max-height:150px; overflow-y:auto; margin-bottom:10px; border:1px solid #eee; border-radius:10px; padding:10px;"></div>
        <div style="background:#f9f9f9; padding:10px; border-radius:10px;">
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="number" id="fixedDay" placeholder="ì¼(Day)" style="width:60px;">
                <input type="text" id="fixedName" placeholder="í•­ëª©ëª… (ì˜ˆ: ì›”ì„¸)">
            </div>
            <input type="text" id="fixedAmount" placeholder="ê¸ˆì•¡" inputmode="numeric" onkeyup="formatCurrencyInput(this)">
            <button class="btn-main" style="width:100%; margin-top:10px; padding:10px;" onclick="addFixedExpenseItem()">ì¶”ê°€í•˜ê¸°</button>
        </div>
        <button class="sheet-btn" style="margin-top:10px;" onclick="document.getElementById('fixedExpenseOverlay').classList.remove('active')">ë‹«ê¸°</button>
    </div>
</div>

<div class="action-sheet-overlay" id="settingsSheet" onclick="closeSettings(event)">
    <div class="action-sheet">
        <div style="border-radius:14px; overflow:hidden; margin-bottom:8px;">
            <button class="sheet-btn" onclick="openFixedSettings()">ğŸ”„ ê³ ì • ì§€ì¶œ ê´€ë¦¬</button>
            <div style="height:1px; background:#E5E5EA;"></div>
            <button class="sheet-btn sheet-delete" onclick="resetAllData()">âš ï¸ ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
        <button class="sheet-btn sheet-cancel" onclick="closeSettingsReal()">ë‹«ê¸°</button>
    </div>
</div>

<div class="action-sheet-overlay" id="actionSheet" onclick="closeActionSheet(event)">
    <div class="action-sheet">
        <div style="border-radius:14px; overflow:hidden; margin-bottom:8px;">
            <button class="sheet-btn" onclick="executeEdit()">ìˆ˜ì •í•˜ê¸°</button>
            <div style="height:1px; background:#E5E5EA;"></div>
            <button class="sheet-btn sheet-delete" onclick="executeDelete()">ì‚­ì œí•˜ê¸°</button>
        </div>
        <button class="sheet-btn sheet-cancel" onclick="closeActionSheetReal()">ì·¨ì†Œ</button>
    </div>
</div>

<script>
    // --- ë°ì´í„° ë¡œë“œ ---
    let balance = parseInt(localStorage.getItem("balance")) || 0;
    let initialSavings = parseInt(localStorage.getItem("initialSavings"));
    if (isNaN(initialSavings)) initialSavings = parseInt(localStorage.getItem("savings")) || 0;
    
    let payday = parseInt(localStorage.getItem("payday")) || 1; 
    let records = JSON.parse(localStorage.getItem("records")) || {};
    let budgets = JSON.parse(localStorage.getItem("dailyBudgets")) || [50000, 30000, 30000, 30000, 30000, 30000, 50000];
    let fixedExpenses = JSON.parse(localStorage.getItem("fixedExpenses")) || []; // [{day:25, name:'ì›”ì„¸', amount:500000}, ...]

    let currentDate = new Date();
    let selectedDate = new Date(); // ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ ìœ ì§€
    let targetKey = null, targetIndex = null, isEditing = false;

    // --- ì´ˆê¸° ì‹¤í–‰ ---
    document.addEventListener("DOMContentLoaded", () => {
        setupLongPress();
        checkAndApplyFixedExpenses(); // ê³ ì •ë¹„ ìë™ ë°˜ì˜ ì²´í¬
        updateDashboard();
        renderCalendar();
        showRecordsForDate(new Date());
    });

    // --- ìœ í‹¸ë¦¬í‹° ---
    function formatMoney(num) { return num.toLocaleString(); }
    function formatCurrencyInput(input) {
        let value = input.value.replace(/[^0-9]/g, '');
        input.value = value ? parseInt(value).toLocaleString() : "";
        if(input.id.startsWith('bg_')) calcBudgetTotal();
    }
    function parseCurrency(str) { return parseInt(str.replace(/,/g, '')) || 0; }
    
    // ë‚ ì§œ í‚¤ ìƒì„± (YYYY-MM-DD) - ë¡œì»¬ íƒ€ì„ì¡´ ê¸°ì¤€ ì™„ë²½ ìˆ˜ì •
    function getDateKey(dateObj) {
        let year = dateObj.getFullYear();
        let month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        let day = dateObj.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function saveData() {
        localStorage.setItem("balance", balance);
        localStorage.setItem("initialSavings", initialSavings);
        localStorage.setItem("payday", payday);
        localStorage.setItem("records", JSON.stringify(records));
        localStorage.setItem("dailyBudgets", JSON.stringify(budgets));
        localStorage.setItem("fixedExpenses", JSON.stringify(fixedExpenses));
        updateDashboard();
        renderCalendar();
    }

    // --- íƒ­ ì „í™˜ ---
    function switchTab(tab) {
        document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        
        if(tab === 'home') {
            document.getElementById('page-home').classList.add('active');
            document.querySelectorAll('.tab-item')[0].classList.add('active');
            renderCalendar();
        } else {
            document.getElementById('page-stats').classList.add('active');
            document.querySelectorAll('.tab-item')[1].classList.add('active');
            renderStats();
        }
    }

    // --- ê³ ì •ë¹„ ë¡œì§ ---
    function openFixedSettings() {
        closeSettingsReal();
        document.getElementById("fixedExpenseOverlay").classList.add("active");
        renderFixedList();
    }
    function closeFixedModal(e) { if(e.target.id==="fixedExpenseOverlay") document.getElementById("fixedExpenseOverlay").classList.remove("active"); }
    
    function addFixedExpenseItem() {
        let day = parseInt(document.getElementById("fixedDay").value);
        let name = document.getElementById("fixedName").value;
        let amount = parseCurrency(document.getElementById("fixedAmount").value);
        if(!day || !name || !amount || day < 1 || day > 31) { alert("ì˜¬ë°”ë¥¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
        
        fixedExpenses.push({ day, name, amount });
        document.getElementById("fixedDay").value = "";
        document.getElementById("fixedName").value = "";
        document.getElementById("fixedAmount").value = "";
        renderFixedList();
        saveData();
    }
    function deleteFixed(idx) {
        fixedExpenses.splice(idx, 1);
        renderFixedList();
        saveData();
    }
    function renderFixedList() {
        let list = document.getElementById("fixedList");
        list.innerHTML = "";
        fixedExpenses.sort((a,b)=>a.day - b.day).forEach((item, idx) => {
            list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee; font-size:14px;">
                <span>ë§¤ì›” ${item.day}ì¼: ${item.name}</span>
                <span>${formatMoney(item.amount)}ì› <span onclick="deleteFixed(${idx})" style="color:red; margin-left:10px; cursor:pointer;">x</span></span>
            </div>`;
        });
    }
    
    // **í•µì‹¬: ê³ ì •ë¹„ ìë™ ë°˜ì˜**
    function checkAndApplyFixedExpenses() {
        let today = new Date();
        let todayDay = today.getDate();
        let key = getDateKey(today);
        let appliedCount = 0;

        fixedExpenses.forEach(fixed => {
            // ì˜¤ëŠ˜ ë‚ ì§œê°€ ê³ ì •ë¹„ ë‚ ì§œì™€ ê°™ê±°ë‚˜ ì§€ë‚¬ëŠ”ì§€ í™•ì¸
            if (todayDay >= fixed.day) {
                // ì´ë²ˆë‹¬ í•´ë‹¹ ê³ ì •ë¹„ ë‚ ì§œ í‚¤ ìƒì„±
                let targetDate = new Date(today.getFullYear(), today.getMonth(), fixed.day);
                let targetKey = getDateKey(targetDate);
                
                // ì´ë¯¸ ê¸°ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
                let alreadyExists = false;
                if(records[targetKey]) {
                    alreadyExists = records[targetKey].some(r => r.category === fixed.name && r.nature === 'fixed');
                }
                
                if(!alreadyExists) {
                    if(!records[targetKey]) records[targetKey] = [];
                    records[targetKey].push({
                        type: 'expense',
                        amount: fixed.amount,
                        category: fixed.name,
                        nature: 'fixed',
                        memo: 'ìë™ë°˜ì˜'
                    });
                    balance -= fixed.amount; // ì”ì•¡ ì°¨ê°
                    appliedCount++;
                }
            }
        });
        if(appliedCount > 0) {
            saveData();
            // alert(`${appliedCount}ê±´ì˜ ê³ ì •ë¹„ê°€ ìë™ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
    }

    // --- ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ---
    function updateDashboard() {
        document.getElementById("balanceDisplay").innerText = formatMoney(balance) + "ì›";
        
        // ì €ì¶• ì´ì•¡
        let totalRecordedSavings = 0;
        Object.values(records).flat().forEach(r => {
            if(r.type === 'saving') totalRecordedSavings += r.amount;
            if(r.type === 'withdraw_saving') totalRecordedSavings -= r.amount;
        });
        document.getElementById("savingsDisplay").innerText = formatMoney(initialSavings + totalRecordedSavings) + "ì›";

        // ì˜ˆìƒ ì”ì•¡ ê³„ì‚° (í˜„ì¬ ì”ê³  - ì´ë²ˆë‹¬ ë‚¨ì€ ê³ ì •ë¹„)
        let todayDay = new Date().getDate();
        let remainingFixed = 0;
        fixedExpenses.forEach(f => { if(f.day > todayDay) remainingFixed += f.amount; });
        document.getElementById("expectedBalanceDisplay").innerText = `(ì˜ˆìƒ ì”ì•¡: ${formatMoney(balance - remainingFixed)}ì›)`;

        // ì•„ë‚€ ëˆ ê³„ì‚°
        let today = new Date();
        let startYear = today.getFullYear(), startMonth = today.getMonth();
        if (today.getDate() < payday) startMonth -= 1;
        
        let accumulatedSaved = 0;
        let loopDate = new Date(startYear, startMonth, payday);
        
        while(loopDate <= today) {
            let key = getDateKey(loopDate);
            let dailyBudget = budgets[loopDate.getDay()];
            let dailyVarExp = 0;
            if(records[key]) records[key].forEach(r => {
                if(r.type === 'expense' && r.nature !== 'fixed') dailyVarExp += r.amount;
            });
            accumulatedSaved += (dailyBudget - dailyVarExp);
            loopDate.setDate(loopDate.getDate() + 1);
        }

        let saveEl = document.getElementById("accumulatedSaveDisplay");
        if(accumulatedSaved >= 0) { saveEl.innerText = "+" + formatMoney(accumulatedSaved) + "ì›"; saveEl.className = "info-value val-good"; }
        else { saveEl.innerText = formatMoney(accumulatedSaved) + "ì›"; saveEl.className = "info-value val-bad"; }
    }

    // --- ì…ë ¥ í¼ ---
    function openForm(mode, record=null) {
        document.getElementById("formOverlay").classList.add("active");
        const typeSelect = document.getElementById("inputType");
        
        if(record) { // ìˆ˜ì •
            document.getElementById("formTitle").innerText = "ë‚´ì—­ ìˆ˜ì •";
            document.getElementById("inputDate").value = targetKey;
            document.getElementById("inputAmount").value = record.amount.toLocaleString();
            document.getElementById("inputMemo").value = record.memo || "";
            typeSelect.value = record.type;
            handleTypeChange();
            // ì¹´í…Œê³ ë¦¬ ë“± ì„¸íŒ… ìƒëµ (ê°„ì†Œí™”)
        } else { // ì‹ ê·œ
            isEditing = false;
            document.getElementById("formTitle").innerText = "ë‚´ì—­ ì¶”ê°€";
            document.getElementById("inputDate").value = getDateKey(selectedDate); // ë‚ ì§œ ì˜¤ë¥˜ ìˆ˜ì • ì ìš©
            document.getElementById("inputAmount").value = "";
            document.getElementById("inputMemo").value = "";
            typeSelect.value = (mode === 'income') ? 'income' : 'expense';
            handleTypeChange();
        }
    }

    function handleTypeChange() {
        let type = document.getElementById("inputType").value;
        let catRow = document.getElementById("categoryRow");
        let natureSelect = document.getElementById("expenseNature");
        
        if(type === 'expense') {
            catRow.classList.remove("hidden");
            natureSelect.classList.remove("hidden");
        } else {
            catRow.classList.add("hidden");
            natureSelect.classList.add("hidden");
        }
    }
    
    function handleCategoryChange() {
        document.getElementById("customCategory").classList.toggle("hidden", document.getElementById("inputCategory").value !== "ê¸°íƒ€");
    }
    function closeForm(e) { if(e.target.id==="formOverlay") document.getElementById("formOverlay").classList.remove("active"); }

    function saveRecord() {
        let dateVal = document.getElementById("inputDate").value;
        let type = document.getElementById("inputType").value;
        let amount = parseCurrency(document.getElementById("inputAmount").value);
        let memo = document.getElementById("inputMemo").value;
        let nature = "variable";
        let category = "-";

        if(!dateVal || amount === 0) { alert("ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”."); return; }

        if(type === 'expense') {
            let catSelect = document.getElementById("inputCategory").value;
            category = (catSelect === 'ê¸°íƒ€') ? (document.getElementById("customCategory").value || 'ê¸°íƒ€') : catSelect;
            nature = document.getElementById("expenseNature").value;
        } else if (type === 'saving') category = 'ì €ì¶•';
        else if (type === 'withdraw_saving') category = 'ì €ì¶• ì¶œê¸ˆ';
        else category = 'ìˆ˜ì…';

        // ìˆ˜ì • ì‹œ ë¡¤ë°±
        if(isEditing) {
            let oldR = records[targetKey][targetIndex];
            if(oldR.type==='income' || oldR.type==='withdraw_saving') balance -= oldR.amount;
            else balance += oldR.amount;
            records[targetKey].splice(targetIndex, 1);
            if(records[targetKey].length === 0) delete records[targetKey];
        }

        if(!records[dateVal]) records[dateVal] = [];
        records[dateVal].push({ type, amount, category, memo, nature });

        // ì”ì•¡ ë°˜ì˜
        if(type === 'income' || type === 'withdraw_saving') balance += amount;
        else balance -= amount;

        saveData();
        document.getElementById("formOverlay").classList.remove("active");
        selectedDate = new Date(dateVal);
        renderCalendar(); showRecordsForDate(selectedDate);
    }

    // --- ë‹¬ë ¥ ë Œë”ë§ ---
    function renderCalendar() {
        let year = currentDate.getFullYear();
        let month = currentDate.getMonth();
        document.getElementById("monthTitle").innerText = `${year}ë…„ ${month+1}ì›”`;
        
        let grid = document.getElementById("calendarGrid");
        grid.innerHTML = "";
        
        let firstDay = new Date(year, month, 1).getDay();
        let lastDate = new Date(year, month+1, 0).getDate();

        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement("div"));

        for(let d=1; d<=lastDate; d++){
            let dateObj = new Date(year, month, d);
            let key = getDateKey(dateObj);
            let dayOfWeek = dateObj.getDay();
            
            let el = document.createElement("div");
            el.className = "day-cell";
            if(key === getDateKey(new Date())) el.classList.add("today");
            if(key === getDateKey(selectedDate)) el.classList.add("selected");
            
            el.innerHTML = `<div class="day-num" style="color:${dayOfWeek===0?'var(--ios-red)':(dayOfWeek===6?'var(--ios-blue)':'black')}">${d}</div>`;
            
            let dotsDiv = document.createElement("div");
            dotsDiv.className = "dots-wrapper";
            
            // ì§€ì¶œ ì²´í¬
            let dailyExp = 0;
            let hasIncome = false;
            if(records[key]) records[key].forEach(r => { 
                if(r.type==='expense' && r.nature!=='fixed') dailyExp+=r.amount; 
                if(r.type==='income') hasIncome = true;
            });
            
            if(dailyExp > 0) {
                let limit = budgets[dayOfWeek];
                let dot = document.createElement("div");
                dot.className = "status-dot";
                if(dailyExp > limit) dot.classList.add("dot-red");
                else if(dailyExp === limit) dot.classList.add("dot-yellow");
                else dot.classList.add("dot-green");
                dotsDiv.appendChild(dot);
            }
            if(hasIncome) {
                let dot = document.createElement("div");
                dot.className = "status-dot dot-blue";
                dotsDiv.appendChild(dot);
            }
            el.appendChild(dotsDiv);
            
            el.onclick = () => { selectedDate = new Date(year, month, d); renderCalendar(); showRecordsForDate(selectedDate); };
            grid.appendChild(el);
        }
    }
    function changeMonth(n) { currentDate.setMonth(currentDate.getMonth()+n); renderCalendar(); }

    function showRecordsForDate(dateObj) {
        let key = getDateKey(dateObj);
        document.getElementById("selectedDateTitle").innerText = `${dateObj.getMonth()+1}ì›” ${dateObj.getDate()}ì¼ ë‚´ì—­`;
        let list = document.getElementById("recordList");
        list.innerHTML = "";
        
        let dayRecords = records[key] || [];
        if(dayRecords.length === 0) { list.innerHTML = `<div style="padding:40px; text-align:center; color:#ccc;">ê¸°ë¡ ì—†ìŒ</div>`; return; }

        dayRecords.forEach((r, idx) => {
            let div = document.createElement("div");
            div.className = "record-item";
            let amountClass = 'amount-expense';
            let sign = '-';
            let metaHtml = "";

            if(r.type === 'income') { amountClass='amount-income'; sign='+'; }
            else if(r.type === 'saving') { amountClass='amount-saving'; sign='-'; }
            else if(r.type === 'withdraw_saving') { amountClass='amount-income'; sign='+'; }
            else { if(r.nature === 'fixed') metaHtml += `<span class="tag-fixed">ê³ ì •ë¹„</span>`; }
            
            if(r.memo) metaHtml += ` <span class="tag-memo">"${r.memo}"</span>`;
            
            div.innerHTML = `
                <div class="record-info">
                    <div class="record-cat">${r.category}</div>
                    <div class="record-meta">${metaHtml}</div>
                </div>
                <div class="${amountClass}">${sign}${formatMoney(r.amount)}ì›</div>
            `;
            // ë¡±í”„ë ˆìŠ¤ ì´ë²¤íŠ¸
            let timer;
            div.addEventListener('touchstart', () => { timer = setTimeout(() => { openActionSheet(key, idx); }, 800); });
            div.addEventListener('touchend', () => clearTimeout(timer));
            div.addEventListener('mousedown', () => { timer = setTimeout(() => { openActionSheet(key, idx); }, 800); });
            div.addEventListener('mouseup', () => clearTimeout(timer));
            
            list.appendChild(div);
        });
    }

    // --- í†µê³„ ë Œë”ë§ ---
    function renderStats() {
        let year = currentDate.getFullYear();
        let month = currentDate.getMonth(); // 0-11
        // ì´ë²ˆë‹¬ ì´ê³„
        let totalIncome = 0;
        let totalExpense = 0;
        let totalSaving = 0;
        
        // ë‚ ì§œ í‚¤ ìˆœíšŒí•˜ë©° ì´ë²ˆë‹¬ ë°ì´í„° ì§‘ê³„
        Object.keys(records).forEach(key => {
            let recDate = new Date(key);
            if(recDate.getFullYear() === year && recDate.getMonth() === month) {
                records[key].forEach(r => {
                    if(r.type === 'income') totalIncome += r.amount;
                    if(r.type === 'expense') totalExpense += r.amount;
                    if(r.type === 'saving') totalSaving += r.amount;
                });
            }
        });
        
        // ê·¸ë˜í”„ ê·¸ë¦¬ê¸° (ê°„ë‹¨ HTML ë°” ì°¨íŠ¸)
        let maxVal = Math.max(totalIncome, totalExpense, totalSaving) || 1;
        
        function makeBar(label, val, color) {
            let percent = (val / maxVal) * 100;
            return `
            <div class="chart-row">
                <div class="chart-label">${label}</div>
                <div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${percent}%; background:${color};"></div></div>
                <div class="chart-value">${formatMoney(val)}</div>
            </div>`;
        }

        document.getElementById("statIncomeExpense").innerHTML = 
            makeBar("ìˆ˜ì…", totalIncome, "var(--ios-blue)") +
            makeBar("ì§€ì¶œ", totalExpense, "var(--ios-black)");
            
        document.getElementById("statSavings").innerHTML = 
            makeBar("ì €ì¶•", totalSaving, "var(--ios-green)");
    }

    // --- ê¸°íƒ€ ì•¡ì…˜ ---
    function openSettings() { document.getElementById("settingsSheet").classList.add("active"); }
    function closeSettings(e) { if(e.target.id === "settingsSheet") document.getElementById("settingsSheet").classList.remove("active"); }
    function closeSettingsReal() { document.getElementById("settingsSheet").classList.remove("active"); }
    function openBudgetModal() { 
        document.getElementById("budgetOverlay").classList.add("active");
        for(let i=0; i<7; i++) document.getElementById(`bg_${i}`).value = budgets[i].toLocaleString();
        calcBudgetTotal();
    }
    function calcBudgetTotal() {
        let weekly = 0;
        for(let i=0; i<7; i++) weekly += parseCurrency(document.getElementById(`bg_${i}`).value);
        document.getElementById("weeklyBudgetTotal").innerText = formatMoney(weekly) + "ì›";
    }
    function saveBudgets() {
        for(let i=0; i<7; i++) budgets[i] = parseCurrency(document.getElementById(`bg_${i}`).value);
        saveData(); document.getElementById("budgetOverlay").classList.remove("active");
    }
    function closeBudgetModal(e) { if(e.target.id==="budgetOverlay") document.getElementById("budgetOverlay").classList.remove("active"); }
    
    // ë¡±í”„ë ˆìŠ¤ (ì„¤ì •)
    function setupLongPress() {
        addLongPressEvent(document.getElementById("boxSavings"), () => {
            document.getElementById("initialSavingsOverlay").classList.add("active");
            document.getElementById("initialSavingsInput").value = initialSavings.toLocaleString();
        });
        addLongPressEvent(document.getElementById("boxSavingGoal"), () => {
            let newPayday = prompt("ê¸°ì¤€ì¼(ì›”ê¸‰ë‚ ) ì…ë ¥ (1~31)", payday);
            if(newPayday) { payday = parseInt(newPayday); saveData(); }
        });
    }
    function addLongPressEvent(el, callback) {
        let timer;
        el.addEventListener('touchstart', () => { timer = setTimeout(() => { navigator.vibrate?.(50); callback(); }, 800); });
        el.addEventListener('touchend', () => clearTimeout(timer));
        el.addEventListener('mousedown', () => { timer = setTimeout(callback, 800); });
        el.addEventListener('mouseup', () => clearTimeout(timer));
    }
    function closeInitialSavingsModal(e) { if(e.target.id==="initialSavingsOverlay") document.getElementById("initialSavingsOverlay").classList.remove("active"); }
    function saveInitialSavings() {
        initialSavings = parseCurrency(document.getElementById("initialSavingsInput").value);
        saveData(); document.getElementById("initialSavingsOverlay").classList.remove("active");
    }

    // ì•¡ì…˜ ì‹œíŠ¸
    function openActionSheet(key, index) {
        targetKey = key; targetIndex = index;
        document.getElementById("actionSheet").classList.add("active");
    }
    function closeActionSheet(e) { if(e.target.id === "actionSheet") document.getElementById("actionSheet").classList.remove("active"); }
    function closeActionSheetReal() { document.getElementById("actionSheet").classList.remove("active"); }
    function executeEdit() {
        closeActionSheetReal(); isEditing = true;
        let record = records[targetKey][targetIndex];
        openForm(null, record);
    }
    function executeDelete() {
        if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        let record = records[targetKey][targetIndex];
        if(record.type==='income' || record.type==='withdraw_saving') balance -= record.amount;
        else balance += record.amount;
        records[targetKey].splice(targetIndex, 1);
        if(records[targetKey].length===0) delete records[targetKey];
        saveData(); closeActionSheetReal(); showRecordsForDate(new Date(targetKey));
    }
    function resetAllData() { if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
