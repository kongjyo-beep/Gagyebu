<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<title>ê°€ê³„ë¶€ì¨ì£ </title>
<meta name="apple-mobile-web-app-title" content="ê°€ê³„ë¶€ì¨ì£ ">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.PNG">
<link rel="shortcut icon" href="icon.PNG">

<style>
    :root {
        /* --- [ìƒ‰ìƒ íŒ”ë ˆíŠ¸: ëˆˆì´ í¸ì•ˆí•œ ì†Œí”„íŠ¸ í†¤] --- */
        --ios-bg: #F5F5F7;
        --ios-card: #FFFFFF;
        
        /* ë©”ì¸ ì»¬ëŸ¬ êµì²´ */
        --ios-blue: #5C95FF;   /* ë¶€ë“œëŸ¬ìš´ ìŠ¤ì¹´ì´ ë¸”ë£¨ */
        --ios-red: #FF6B6B;    /* ë§ë¦° ì¥ë¯¸ë¹› ë ˆë“œ */
        --ios-green: #51CF66;  /* ì°¨ë¶„í•œ ë¯¼íŠ¸ ê·¸ë¦° */
        --ios-yellow: #FFD43B; /* ë”°ëœ»í•œ ì˜ë¡œìš° */
        --ios-indigo: #845EF7; /* ì†Œí”„íŠ¸ í¼í”Œ */
        
        --ios-gray-text: #868e96;
        --ios-border: #E9ECEF;
        --ios-black: #343A40;
        --safe-bottom: env(safe-area-inset-bottom);
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--ios-bg);
        margin: 0; padding: 0; color: var(--ios-black);
        -webkit-font-smoothing: antialiased; 
        user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;
        padding-bottom: calc(70px + var(--safe-bottom));
    }

    /* --- ë ˆì´ì•„ì›ƒ --- */
    .view-container { display: none; animation: fadeIn 0.2s; }
    .view-container.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- í—¤ë” --- */
    .header-card {
        background: var(--ios-card); 
        padding: calc(env(safe-area-inset-top) + 15px) 20px 24px 20px;
        border-bottom-left-radius: 28px; border-bottom-right-radius: 28px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.04); margin-bottom: 20px; position: relative;
    }
    .settings-btn {
        position: absolute; top: calc(env(safe-area-inset-top) + 15px); right: 20px;
        background: none; border: none; cursor: pointer; padding: 5px; opacity: 0.5;
    }
    .settings-btn svg { width: 24px; height: 24px; fill: var(--ios-gray-text); }
    
    .main-balance { text-align: center; margin-bottom: 20px; margin-top: 10px; }
    .header-label { font-size: 14px; color: var(--ios-gray-text); margin-bottom: 4px; font-weight: 500; }
    .balance-amount { font-size: 38px; font-weight: 800; letter-spacing: -0.8px; color: #212529; }
    .expected-balance { font-size: 13px; color: var(--ios-indigo); font-weight: 600; margin-top: 6px; background: #F3F0FF; padding: 4px 10px; border-radius: 12px; display: inline-block;}

    /* ì„œë¸Œ ì •ë³´ */
    .sub-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .info-box {
        background: #F8F9FA; border-radius: 18px; padding: 14px; text-align: center;
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.02); transition: background 0.2s; cursor: pointer;
    }
    .info-box:active { background: #E9ECEF; }
    .info-title { font-size: 12px; color: #ADB5BD; margin-bottom: 5px; font-weight: 600; }
    .info-value { font-size: 17px; font-weight: 700; }
    .val-saving { color: var(--ios-blue); }
    .val-good { color: var(--ios-green); }
    .val-bad { color: var(--ios-red); }

    /* ë²„íŠ¼ ê·¸ë£¹ */
    .action-row { display: flex; gap: 10px; margin-top: 0; }
    .btn-main {
        flex: 1; padding: 14px 0; border-radius: 16px; border: none;
        font-size: 15px; font-weight: 600; color: white;
        background: var(--ios-blue); cursor: pointer; transition: opacity 0.2s;
        box-shadow: 0 4px 12px rgba(92, 149, 255, 0.3);
    }
    .btn-main:active { opacity: 0.8; transform: scale(0.98); }
    .btn-income { background: var(--ios-green); box-shadow: 0 4px 12px rgba(81, 207, 102, 0.3); }
    .btn-budget { background: white; color: var(--ios-blue); border: 1px solid var(--ios-blue); box-shadow: none; }

    /* --- ë‹¬ë ¥ --- */
    .calendar-container {
        background: var(--ios-card); margin: 0 16px; border-radius: 24px;
        padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.03);
    }
    .cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .cal-title { font-size: 18px; font-weight: 700; color: #495057; }
    .nav-btn { 
        background: #F8F9FA; border: none; width: 34px; height: 34px; border-radius: 50%;
        font-size: 14px; color: var(--ios-blue); cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: #ADB5BD; margin-bottom: 8px; font-weight: 600; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    
    .day-cell {
        /* ë†’ì´ ì¤„ì„ (58 -> 52) */
        height: 52px; 
        display: flex; flex-direction: column; align-items: center;
        cursor: pointer; border-radius: 12px; position: relative; padding-top: 4px;
    }
    .day-cell.today { background: rgba(92, 149, 255, 0.1); }
    .day-cell.selected { border: 2px solid var(--ios-blue); }
    .day-num { font-size: 15px; font-weight: 500; margin-bottom: 3px; color: #495057;}
    
    /* ì  ì»¨í…Œì´ë„ˆ */
    .dots-container { display: flex; flex-direction: column; gap: 4px; align-items: center; } /* gap ìœ ì§€ */
    .status-dot { width: 5px; height: 5px; border-radius: 50%; }
    .dot-green { background-color: var(--ios-green); }
    .dot-yellow { background-color: var(--ios-yellow); }
    .dot-red { background-color: var(--ios-red); }
    .dot-blue { background-color: var(--ios-blue); }
    .sun { color: var(--ios-red); } .sat { color: var(--ios-blue); }
    
    .legend-row {
        display: flex; justify-content: center; gap: 12px; margin-top: 15px;
        padding-top: 12px; border-top: 1px solid #F1F3F5;
    }
    .legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: #868e96; }

    /* --- ë¦¬ìŠ¤íŠ¸ --- */
    .detail-section { margin: 20px 16px; }
    .list-header { font-size: 17px; font-weight:700; margin-bottom: 10px; margin-left: 5px; color: #495057; }
    .record-list { background: var(--ios-card); border-radius: 20px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
    .record-item {
        padding: 16px; border-bottom: 1px solid var(--ios-border);
        display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;
    }
    .record-item:active { background: #f8f9fa; }
    .record-info { display: flex; flex-direction: column; gap: 3px; }
    .record-cat { font-size: 15px; font-weight: 600; color: #343a40; }
    .record-meta { font-size: 12px; color: #adb5bd; display: flex; gap: 5px; align-items: center;}
    .tag-fixed { background: #E9ECEF; color: #495057; padding: 2px 6px; border-radius: 6px; font-size: 10px; font-weight: 600;}
    .tag-memo { color: #868e96; font-style: italic;}
    .amount-expense { color: var(--ios-black); font-weight:600; font-size: 16px; }
    .amount-income { color: var(--ios-blue); font-weight:600; font-size: 16px; }
    .amount-saving { color: var(--ios-green); font-weight:600; font-size: 16px; }

    /* --- í†µê³„ í˜ì´ì§€ --- */
    .stats-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 0 20px; }
    .stats-card { background: white; border-radius: 20px; padding: 20px; margin: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
    .stats-title { font-size: 16px; font-weight: 700; margin-bottom: 18px; color: #343a40; }
    
    .budget-summary { background: #F8F9FA; border-radius: 16px; padding: 18px; margin-bottom: 20px; }
    .bs-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; color: #868e96; }
    .bs-row.total { font-size: 15px; font-weight: 700; color: #343a40; margin-top: 12px; border-top: 1px solid #dee2e6; padding-top: 12px; margin-bottom: 0; }
    .bs-highlight { color: var(--ios-blue); font-weight: 600; }

    /* íŒŒì´ ì°¨íŠ¸ (SVG ì‚¬ìš©) */
    .chart-container { display: flex; align-items: center; justify-content: center; position: relative; height: 180px; margin-bottom: 10px; }
    /* ë„ë„› ì°¨íŠ¸ SVG ì• ë‹ˆë©”ì´ì…˜ */
    .donut-chart { width: 160px; height: 160px; transform: rotate(-90deg); }
    .donut-bg { fill: none; stroke: #eee; stroke-width: 3.5; }
    .donut-segment { fill: none; stroke-width: 3.5; stroke-dasharray: 0 100; transition: stroke-dasharray 0.5s ease; }
    
    .pie-center-text { position: absolute; text-align: center; font-size: 12px; color: #888; }
    
    .chart-legend { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-top: 15px; }
    .legend-text { font-size: 12px; color: #495057; display: flex; align-items: center; }
    .legend-dot { width: 10px; height: 10px; border-radius: 3px; display: inline-block; margin-right: 5px; }

    /* ì„  ê·¸ë˜í”„ */
    .line-chart-wrapper { overflow-x: auto; padding-bottom: 10px; white-space: nowrap; -webkit-overflow-scrolling: touch; }
    .line-chart-svg { height: 150px; min-width: 100%; } 
    .line-point { r: 5; fill: white; stroke-width: 3; }
    .line-path { fill: none; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; }
    .line-text { font-size: 11px; fill: #adb5bd; text-anchor: middle; font-weight: 500; }

    /* --- í•˜ë‹¨ íƒ­ë°” --- */
    .tab-bar {
        position: fixed; bottom: 0; left: 0; right: 0;
        background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
        border-top: 1px solid #E9ECEF;
        display: flex; justify-content: space-around;
        padding-bottom: var(--safe-bottom);
        height: 60px; z-index: 100;
    }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #CED4DA; cursor: pointer; }
    .tab-item.active { color: var(--ios-black); }
    .tab-icon svg { width: 26px; height: 26px; fill: currentColor; margin-bottom: 3px; }
    .tab-label { font-size: 10px; font-weight: 600; }

    .footer-copy { text-align: center; color: #DEE2E6; font-size: 10px; margin-top: 30px; margin-bottom: 100px;}

    /* ëª¨ë‹¬ ê³µí†µ */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); display: none; z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .modal-overlay.active { display: flex; }
    .input-group { background: white; width: 85%; max-width: 360px; padding: 24px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); animation: popUp 0.2s cubic-bezier(0.16, 1, 0.3, 1); max-height: 85vh; overflow-y: auto; }
    @keyframes popUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .form-row { margin-bottom: 14px; }
    .form-label { font-size: 13px; font-weight:600; color: #495057; margin-bottom: 6px; display: block; }
    input, select { width: 100%; box-sizing: border-box; padding: 14px; border-radius: 12px; border: 1px solid #DEE2E6; font-size: 16px; background: #F8F9FA; -webkit-appearance: none; }
    input:focus, select:focus { background: white; border-color: var(--ios-blue); outline: none; }
    .hidden { display: none; }

    /* ì˜ˆì‚° íƒ­ */
    .budget-tabs { display: flex; background: #F1F3F5; border-radius: 12px; padding: 4px; margin-bottom: 20px; }
    .budget-tab-item { flex: 1; text-align: center; padding: 10px 0; font-size: 13px; color: #868e96; border-radius: 10px; cursor: pointer; font-weight: 600;}
    .budget-tab-item.active { background: white; color: var(--ios-black); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    /* ì•¡ì…˜ ì‹œíŠ¸ */
    .action-sheet-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.4); z-index: 3000; display: none; align-items: flex-end; }
    .action-sheet-overlay.active { display: flex; }
    .action-sheet { background: transparent; width: 100%; padding: 10px; box-sizing: border-box; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .sheet-btn { background: white; border: none; width: 100%; padding: 16px; font-size: 16px; color: var(--ios-blue); margin-bottom: 1px; cursor: pointer; font-weight: 500; }
    .sheet-btn:first-child { border-top-left-radius: 14px; border-top-right-radius: 14px; }
    .sheet-btn:last-child { border-bottom-left-radius: 14px; border-bottom-right-radius: 14px; margin-bottom: 8px; }
    .sheet-cancel { border-radius: 14px; font-weight: 600; background: white; color: #495057;}
    .sheet-delete { color: var(--ios-red); }

</style>
</head>
<body>

<div id="page-home" class="view-container active">
    <div class="header-card">
        <button class="settings-btn" onclick="openSettings()">
            <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
        </button>
        <div class="main-balance">
            <div class="header-label">í˜„ì¬ ì”ê³ </div>
            <div class="balance-amount" id="balanceDisplay">0ì›</div>
            <div class="expected-balance" id="expectedBalanceDisplay">ì˜ˆìƒ ì”ì•¡ 0ì›</div>
        </div>

        <div class="sub-info-grid">
            <div class="info-box" id="boxSavings">
                <div class="info-title">ğŸ’° ì €ì¶• í†µì¥</div>
                <div class="info-value val-saving" id="savingsDisplay">0ì›</div>
            </div>
            <div class="info-box" id="boxSavingGoal">
                <div class="info-title">ğŸ‘ ì´ë²ˆ ë‹¬ ì•„ë‚€ ëˆ</div>
                <div class="info-value" id="accumulatedSaveDisplay">0ì›</div>
            </div>
        </div>

        <div class="action-row">
            <button class="btn-main" onclick="openForm('expense')">ì§€ì¶œ</button>
            <button class="btn-main btn-income" onclick="openForm('income')">ìˆ˜ì…</button>
            <button class="btn-main btn-budget" onclick="openBudgetModal()">ì˜ˆì‚°</button>
        </div>
    </div>

    <div class="calendar-container">
        <div class="cal-nav">
            <button class="nav-btn" onclick="changeMonth(-1)">â—€</button>
            <div class="cal-title" id="monthTitle"></div>
            <button class="nav-btn" onclick="changeMonth(1)">â–¶</button>
        </div>
        <div class="weekdays">
            <div class="sun">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="sat">í† </div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
        <div class="legend-row">
            <div class="legend-item"><div class="status-dot dot-red"></div>ì´ˆê³¼</div>
            <div class="legend-item"><div class="status-dot dot-yellow"></div>ì£¼ì˜</div>
            <div class="legend-item"><div class="status-dot dot-green"></div>ì„±ê³µ</div>
            <div class="legend-item"><div class="status-dot dot-blue"></div>ìˆ˜ì…</div>
        </div>
    </div>

    <div class="detail-section">
        <div class="list-header" id="selectedDateTitle">ì˜¤ëŠ˜ì˜ ë‚´ì—­</div>
        <div class="record-list" id="recordList"></div>
    </div>
</div>

<div id="page-stats" class="view-container">
    <div class="stats-header">
        <h2 style="margin:0; font-size:22px; color:#343a40;">ì›”ê°„ ë¶„ì„</h2>
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="nav-btn" style="width:28px; height:28px;" onclick="changeStatsMonth(-1)">â—€</button>
            <span id="statsDateTitle" style="font-size:15px; font-weight:600; color:#343a40;"></span>
            <button class="nav-btn" style="width:28px; height:28px;" onclick="changeStatsMonth(1)">â–¶</button>
        </div>
    </div>

    <div class="stats-card">
        <div class="stats-title">ì˜ˆì‚° ë¦¬í¬íŠ¸</div>
        <div class="budget-summary">
            <div class="bs-row"><span>ì´ ìˆ˜ì…</span><span id="statTotalIncome" class="bs-highlight">0ì›</span></div>
            <div class="bs-row"><span>ê³ ì • ì§€ì¶œ</span><span id="statFixedExpense">0ì›</span></div>
            <div class="bs-row total"><span>ìˆœìˆ˜ ê°€ìš© ì˜ˆì‚° (ë³€ë™ë¹„)</span><span id="statAvailableBudget">0ì›</span></div>
        </div>
        <div class="budget-summary" style="background:white; border:1px solid #E9ECEF; margin-bottom:0;">
             <div class="bs-row" style="margin-bottom:0; align-items:center;">
                <span>ì´ í¸ì„± ì˜ˆì‚° (ì¼ì¼ ì˜ˆì‚° í•©ê³„)</span>
                <span id="statPlannedBudget" style="font-weight:600; font-size:14px; color:#343a40;">0ì›</span>
            </div>
        </div>
    </div>

    <div class="stats-card">
        <div class="stats-title">ì§€ì¶œ êµ¬ì¡° (ê³ ì •/ë³€ë™)</div>
        <div class="chart-container">
            <svg id="pieChartType" class="donut-chart" viewBox="0 0 32 32"></svg>
        </div>
        <div class="chart-legend" id="legendType"></div>
    </div>

    <div class="stats-card">
        <div class="stats-title">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</div>
        <div class="chart-container">
            <svg id="pieChartCat" class="donut-chart" viewBox="0 0 32 32"></svg>
        </div>
        <div class="chart-legend" id="legendCat"></div>
    </div>

    <div class="stats-card">
        <div class="stats-title">ì›”ë³„ ì ˆì•½ ì¶”ì´ (ì „ì²´ ê¸°ê°„)</div>
        <p style="font-size:11px; color:#adb5bd; margin-top:-10px; margin-bottom:15px;">ì¢Œìš°ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ ì „ì²´ ê¸°ë¡ì„ í™•ì¸í•˜ì„¸ìš”.</p>
        <div class="line-chart-wrapper">
            <svg class="line-chart-svg" id="savingTrendChart"></svg>
        </div>
    </div>
</div>

<div class="tab-bar">
    <div class="tab-item active" onclick="switchTab('home')">
        <div class="tab-icon"><svg viewBox="0 0 24 24"><path d="M12 5.69l5 4.5V18h-2v-6H9v6H7v-7.81l5-4.5M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"/></svg></div>
        <div class="tab-label">ê°€ê³„ë¶€</div>
    </div>
    <div class="tab-item" onclick="switchTab('stats')">
        <div class="tab-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg></div>
        <div class="tab-label">í†µê³„</div>
    </div>
</div>

<div class="footer-copy">Made by Jyo<br>Â© 2026 Gagyebu Project</div>

<div class="modal-overlay" id="formOverlay" onclick="closeForm(event)">
    <div class="input-group" id="inputForm">
        <h3 id="formTitle" style="margin:0 0 20px 0; color:#343a40;">ë‚´ì—­ ì¶”ê°€</h3>
        <div class="form-row"><label class="form-label">ë‚ ì§œ</label><input type="date" id="inputDate"></div>
        <div class="form-row">
            <label class="form-label">ìœ í˜•</label>
            <div style="display:flex; gap:10px;">
                <select id="inputType" onchange="handleTypeChange()" style="flex:1;">
                    <option value="expense">ì§€ì¶œ</option><option value="saving">ì €ì¶•</option>
                    <option value="withdraw_saving">ì €ì¶• ì¶œê¸ˆ (ê¹¨ê¸°)</option><option value="income">ìˆ˜ì…</option>
                </select>
                <select id="expenseNature" class="hidden" style="flex:1; border-color:#5C95FF; color:#5C95FF; font-weight:600;">
                    <option value="variable">ë³€ë™ë¹„</option><option value="fixed">ê³ ì •ë¹„</option>
                </select>
            </div>
        </div>
        <div class="form-row" id="categoryRow">
            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
            <select id="inputCategory" onchange="handleCategoryChange()">
                <option value="ì‹ë¹„">ì‹ë¹„</option><option value="êµí†µ">êµí†µ</option><option value="ì‡¼í•‘">ì‡¼í•‘</option>
                <option value="ì£¼ê±°">ì£¼ê±°/í†µì‹ </option><option value="ì˜ë£Œ">ì˜ë£Œ/ê±´ê°•</option><option value="ë¬¸í™”">ë¬¸í™”/ì—¬ê°€</option><option value="ê¸°íƒ€">ê¸°íƒ€ (ì§ì ‘ì…ë ¥)</option>
            </select>
            <input type="text" id="customCategory" class="hidden" placeholder="ì¹´í…Œê³ ë¦¬ëª… ì…ë ¥" style="margin-top:8px;">
        </div>
        <div class="form-row"><label class="form-label">ê¸ˆì•¡</label><input type="text" id="inputAmount" placeholder="0" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
        <div class="form-row"><label class="form-label">ë©”ëª¨</label><input type="text" id="inputMemo" placeholder="ë‚´ìš© ì…ë ¥"></div>
        <button class="btn-main" style="width:100%" onclick="saveRecord()">ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<div class="modal-overlay" id="initialSavingsOverlay" onclick="closeInitialSavingsModal(event)">
    <div class="input-group">
        <h3>ì €ì¶• í†µì¥ ì„¤ì •</h3>
        <p style="font-size:13px; color:#868e96;">ê¸°ì´ˆ ì”ì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
        <input type="text" id="initialSavingsInput" inputmode="numeric" onkeyup="formatCurrencyInput(this)" style="font-size:24px; text-align:center;">
        <button class="btn-main" style="width:100%; margin-top:20px;" onclick="saveInitialSavings()">ì €ì¥</button>
    </div>
</div>

<div class="modal-overlay" id="budgetOverlay" onclick="closeBudgetModal(event)">
    <div class="input-group">
        <h3 style="color:#343a40;">ìš”ì¼ë³„ ì˜ˆì‚°</h3>
        <div class="budget-tabs">
            <div class="budget-tab-item active" id="btnModeManual" onclick="setBudgetMode('manual')">ì§ì ‘ ì…ë ¥</div>
            <div class="budget-tab-item" id="btnModeWeek" onclick="setBudgetMode('week')">í‰ì¼/ì£¼ë§</div>
            <div class="budget-tab-item" id="btnModeAll" onclick="setBudgetMode('all')">ë§¤ì¼ ê°™ê²Œ</div>
        </div>
        <div id="budgetInputsManual">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                <div><label class="form-label" style="color:#FF6B6B">ì¼</label><input type="text" id="bg_0" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
                <div><label class="form-label">ì›”</label><input type="text" id="bg_1" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
                <div><label class="form-label">í™”</label><input type="text" id="bg_2" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
                <div><label class="form-label">ìˆ˜</label><input type="text" id="bg_3" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
                <div><label class="form-label">ëª©</label><input type="text" id="bg_4" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
                <div><label class="form-label">ê¸ˆ</label><input type="text" id="bg_5" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
                <div><label class="form-label" style="color:#5C95FF">í† </label><input type="text" id="bg_6" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
            </div>
        </div>
        <div id="budgetInputsWeek" class="hidden">
            <div style="margin-bottom:20px;">
                <label class="form-label">í‰ì¼ (ì›”~ê¸ˆ)</label><input type="text" id="bg_weekday" inputmode="numeric" onkeyup="formatCurrencyInput(this)" placeholder="í‰ì¼ ì˜ˆì‚°">
                <div style="height:15px;"></div>
                <label class="form-label" style="color:#5C95FF">ì£¼ë§ (í† ,ì¼)</label><input type="text" id="bg_weekend" inputmode="numeric" onkeyup="formatCurrencyInput(this)" placeholder="ì£¼ë§ ì˜ˆì‚°">
            </div>
        </div>
        <div id="budgetInputsAll" class="hidden">
            <div style="margin-bottom:20px;">
                <label class="form-label">ë§¤ì¼ (ì›”~ì¼)</label><input type="text" id="bg_everyday" inputmode="numeric" onkeyup="formatCurrencyInput(this)" placeholder="í•˜ë£¨ ì˜ˆì‚°">
            </div>
        </div>
        <div style="background:#F8F9FA; padding:15px; border-radius:12px; margin-bottom:15px;">
            <div style="display:flex; justify-content:space-between; color:#495057;"><span>ì£¼ê°„ ì´ ì˜ˆì‚°</span><span id="weeklyBudgetTotal" style="font-weight:600;">0ì›</span></div>
        </div>
        <button class="btn-main" style="width:100%;" onclick="saveBudgets()">ì €ì¥</button>
    </div>
</div>

<div class="action-sheet-overlay" id="settingsSheet" onclick="closeSettings(event)">
    <div class="action-sheet">
        <div style="border-radius:14px; overflow:hidden; margin-bottom:8px;">
            <button class="sheet-btn sheet-delete" onclick="resetAllData()">âš ï¸ ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
        <button class="sheet-btn sheet-cancel" onclick="closeSettingsReal()">ë‹«ê¸°</button>
    </div>
</div>

<div class="action-sheet-overlay" id="actionSheet" onclick="closeActionSheet(event)">
    <div class="action-sheet">
        <div style="border-radius:14px; overflow:hidden; margin-bottom:8px;">
            <button class="sheet-btn" onclick="executeEdit()">ìˆ˜ì •í•˜ê¸°</button>
            <div style="height:1px; background:#E9ECEF;"></div>
            <button class="sheet-btn sheet-delete" onclick="executeDelete()">ì‚­ì œí•˜ê¸°</button>
        </div>
        <button class="sheet-btn sheet-cancel" onclick="closeActionSheetReal()">ì·¨ì†Œ</button>
    </div>
</div>

<script>
    // --- ë°ì´í„° ë¡œë“œ ---
    let balance = parseInt(localStorage.getItem("balance")) || 0;
    let initialSavings = parseInt(localStorage.getItem("initialSavings"));
    if (isNaN(initialSavings)) initialSavings = parseInt(localStorage.getItem("savings")) || 0;
    let payday = parseInt(localStorage.getItem("payday")) || 1; 
    let records = JSON.parse(localStorage.getItem("records")) || {};
    let budgets = JSON.parse(localStorage.getItem("dailyBudgets")) || [50000, 30000, 30000, 30000, 30000, 30000, 50000];

    let currentDate = new Date();
    let selectedDate = new Date(); 
    let currentStatsDate = new Date(); 
    let targetKey = null, targetIndex = null, isEditing = false;
    
    // íŒŒìŠ¤í…” í†¤ ì°¨íŠ¸ ì»¬ëŸ¬ íŒ”ë ˆíŠ¸
    const colors = ['#FF6B6B', '#FFD43B', '#51CF66', '#5C95FF', '#845EF7', '#FCC419', '#20C997', '#94D82D', '#FF922B'];

    document.addEventListener("DOMContentLoaded", () => {
        setupLongPress();
        updateDashboard();
        renderCalendar();
        showRecordsForDate(new Date());
    });

    // --- ìœ í‹¸ë¦¬í‹° ---
    function formatMoney(num) { return num.toLocaleString(); }
    function formatCurrencyInput(input) {
        let value = input.value.replace(/[^0-9]/g, '');
        input.value = value ? parseInt(value).toLocaleString() : "";
        if(document.getElementById("budgetOverlay").classList.contains("active")) calcBudgetTotal();
    }
    function parseCurrency(str) { return parseInt(str.replace(/,/g, '')) || 0; }
    function getDateKey(dateObj) {
        let year = dateObj.getFullYear();
        let month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        let day = dateObj.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    function saveData() {
        localStorage.setItem("balance", balance);
        localStorage.setItem("initialSavings", initialSavings);
        localStorage.setItem("payday", payday);
        localStorage.setItem("records", JSON.stringify(records));
        localStorage.setItem("dailyBudgets", JSON.stringify(budgets));
        updateDashboard(); renderCalendar();
    }

    // --- íƒ­ ì „í™˜ ---
    function switchTab(tab) {
        document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        if(tab === 'home') {
            document.getElementById('page-home').classList.add('active');
            document.querySelectorAll('.tab-item')[0].classList.add('active');
            renderCalendar();
        } else {
            document.getElementById('page-stats').classList.add('active');
            document.querySelectorAll('.tab-item')[1].classList.add('active');
            renderStats();
        }
    }

    // --- í†µê³„ ---
    function changeStatsMonth(delta) {
        currentStatsDate.setMonth(currentStatsDate.getMonth() + delta);
        renderStats();
    }

    function renderStats() {
        let year = currentStatsDate.getFullYear();
        let month = currentStatsDate.getMonth();
        document.getElementById("statsDateTitle").innerText = `${year}ë…„ ${month+1}ì›”`;

        let monthlyData = getMonthlyData(year, month);
        
        document.getElementById("statTotalIncome").innerText = formatMoney(monthlyData.income) + "ì›";
        document.getElementById("statFixedExpense").innerText = formatMoney(monthlyData.fixed) + "ì›";
        let available = monthlyData.income - monthlyData.fixed;
        document.getElementById("statAvailableBudget").innerText = formatMoney(available) + "ì›";
        
        let daysInMonth = new Date(year, month+1, 0).getDate();
        let plannedTotal = 0;
        for(let d=1; d<=daysInMonth; d++) plannedTotal += budgets[new Date(year, month, d).getDay()];
        document.getElementById("statPlannedBudget").innerText = formatMoney(plannedTotal) + "ì›";

        // SVG ë„ë„› ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        renderSvgPieChart("pieChartType", "legendType", [
            { label: "ê³ ì •ë¹„", value: monthlyData.fixed, color: "#FF6B6B" },
            { label: "ë³€ë™ë¹„", value: monthlyData.variable, color: "#5C95FF" }
        ]);

        let catData = Object.keys(monthlyData.categories).map((cat, idx) => ({
            label: cat, value: monthlyData.categories[cat], color: colors[idx % colors.length]
        })).sort((a,b) => b.value - a.value);
        renderSvgPieChart("pieChartCat", "legendCat", catData);

        renderSavingTrendChart();
    }

    function getMonthlyData(year, month) {
        let income = 0; let fixed = 0; let variable = 0; let categories = {};
        Object.keys(records).forEach(key => {
            let rDate = new Date(key);
            if(rDate.getFullYear() === year && rDate.getMonth() === month) {
                records[key].forEach(r => {
                    if(r.type === 'income') income += r.amount;
                    else if(r.type === 'expense') {
                        if(r.nature === 'fixed') fixed += r.amount;
                        else {
                            variable += r.amount;
                            categories[r.category] = (categories[r.category] || 0) + r.amount;
                        }
                    }
                });
            }
        });
        return { income, fixed, variable, categories };
    }

    // *** SVG íŒŒì´ ì°¨íŠ¸ ì—”ì§„ (ì™„ë²½í•œ ë„ë„›) ***
    function renderSvgPieChart(svgId, legendId, data) {
        let svg = document.getElementById(svgId);
        let legend = document.getElementById(legendId);
        svg.innerHTML = ""; legend.innerHTML = "";
        
        let total = data.reduce((sum, item) => sum + item.value, 0);
        
        if(total === 0) {
            // ë¹ˆ ë°ì´í„° íšŒìƒ‰ ì›
            svg.innerHTML = `<circle cx="16" cy="16" r="15.9155" fill="none" stroke="#F1F3F5" stroke-width="32"></circle>`;
            legend.innerHTML = "<span style='font-size:12px; color:#adb5bd;'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>";
            return;
        }

        let cumPercent = 0;
        data.forEach(item => {
            if(item.value <= 0) return;
            
            let percent = (item.value / total) * 100;
            // SVG circle dasharray trick
            // r=15.9155ì¼ ë•Œ ë‘˜ë ˆëŠ” ì •í™•íˆ 100ì´ ë¨.
            let circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("cx", "16");
            circle.setAttribute("cy", "16");
            circle.setAttribute("r", "15.9155");
            circle.setAttribute("fill", "none");
            circle.setAttribute("stroke", item.color);
            circle.setAttribute("stroke-width", "6"); // ë‘ê»˜
            circle.setAttribute("stroke-dasharray", `${percent} ${100 - percent}`);
            circle.setAttribute("stroke-dashoffset", -cumPercent); // ì‹œì‘ ì§€ì  íšŒì „
            
            svg.appendChild(circle);
            cumPercent += percent;

            legend.innerHTML += `
                <div class="legend-text">
                    <span class="legend-dot" style="background:${item.color}"></span>
                    ${item.label} (${Math.round(percent)}%)
                </div>
            `;
        });
    }

    function renderSavingTrendChart() {
        let svg = document.getElementById("savingTrendChart");
        svg.innerHTML = "";
        let points = [];
        let labels = [];
        
        let allDates = Object.keys(records).sort();
        let startD = allDates.length > 0 ? new Date(allDates[0]) : new Date();
        startD.setDate(1); 
        let endD = new Date(currentStatsDate.getFullYear(), currentStatsDate.getMonth(), 1);
        let loopD = new Date(startD);
        
        // ìµœì†Œ 1ê°œë¼ë„ ì ì„ ì°ê¸° ìœ„í•´ startDê°€ endDë³´ë‹¤ ë¯¸ë˜ë©´ ì¡°ì •
        if(startD > endD) loopD = new Date(endD);

        while(loopD <= endD) {
            let y = loopD.getFullYear();
            let m = loopD.getMonth();
            let daysInMonth = new Date(y, m+1, 0).getDate();
            let monthBudget = 0;
            for(let day=1; day<=daysInMonth; day++) monthBudget += budgets[new Date(y, m, day).getDay()];
            let monthData = getMonthlyData(y, m);
            let saved = monthBudget - monthData.variable;
            points.push(saved);
            labels.push(`${m+1}ì›”`);
            loopD.setMonth(loopD.getMonth() + 1);
        }

        let pointWidth = 60;
        let totalW = Math.max(points.length * pointWidth + 40, svg.clientWidth); 
        svg.style.width = `${totalW}px`;
        svg.setAttribute("viewBox", `0 0 ${totalW} 150`); 

        let h = 150; let padding = 20;
        let minVal = Math.min(...points, 0);
        let maxVal = Math.max(...points, 10000);
        let range = maxVal - minVal || 1;

        const getX = (idx) => padding + (idx * pointWidth);
        const getY = (val) => h - padding - ((val - minVal) / range) * (h - 2*padding);

        if(minVal < 0 && maxVal > 0) {
            let zeroY = getY(0);
            svg.innerHTML += `<line x1="0" y1="${zeroY}" x2="${totalW}" y2="${zeroY}" stroke="#E9ECEF" stroke-dasharray="4"/>`;
        }

        let pathD = "";
        points.forEach((val, idx) => {
            let x = getX(idx); let y = getY(val);
            pathD += (idx === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
        });
        svg.innerHTML += `<path d="${pathD}" class="line-path" stroke="#5C95FF" />`;

        points.forEach((val, idx) => {
            let x = getX(idx); let y = getY(val);
            let color = val >= 0 ? "#51CF66" : "#FF6B6B";
            svg.innerHTML += `<circle cx="${x}" cy="${y}" r="5" fill="white" stroke="${color}" stroke-width="3"/>`;
            let textVal = Math.round(val / 10000);
            svg.innerHTML += `<text x="${x}" y="${y - 12}" font-size="11" fill="#868e96" text-anchor="middle" font-weight="600">${textVal}ë§Œ</text>`;
            svg.innerHTML += `<text x="${x}" y="${h - 2}" font-size="11" fill="#adb5bd" text-anchor="middle">${labels[idx]}</text>`;
        });
    }

    // --- ì˜ˆì‚° ëª¨ë‹¬ ---
    let currentBudgetMode = 'manual';
    function setBudgetMode(mode) {
        currentBudgetMode = mode;
        document.querySelectorAll('.budget-tab-item').forEach(el => el.classList.remove('active'));
        document.getElementById(mode === 'manual' ? 'btnModeManual' : (mode === 'week' ? 'btnModeWeek' : 'btnModeAll')).classList.add('active');
        document.getElementById('budgetInputsManual').classList.add('hidden');
        document.getElementById('budgetInputsWeek').classList.add('hidden');
        document.getElementById('budgetInputsAll').classList.add('hidden');
        if(mode === 'manual') document.getElementById('budgetInputsManual').classList.remove('hidden');
        else if(mode === 'week') document.getElementById('budgetInputsWeek').classList.remove('hidden');
        else document.getElementById('budgetInputsAll').classList.remove('hidden');
    }
    function openBudgetModal() { 
        document.getElementById("budgetOverlay").classList.add("active");
        for(let i=0; i<7; i++) document.getElementById(`bg_${i}`).value = budgets[i].toLocaleString();
        setBudgetMode('manual'); calcBudgetTotal();
    }
    function calcBudgetTotal() {
        if(currentBudgetMode === 'week') {
            let w = parseCurrency(document.getElementById('bg_weekday').value);
            let e = parseCurrency(document.getElementById('bg_weekend').value);
            document.getElementById("weeklyBudgetTotal").innerText = formatMoney((w * 5) + (e * 2)) + "ì›";
        } else if (currentBudgetMode === 'all') {
            let val = parseCurrency(document.getElementById('bg_everyday').value);
            document.getElementById("weeklyBudgetTotal").innerText = formatMoney(val * 7) + "ì›";
        } else {
            let weekly = 0;
            for(let i=0; i<7; i++) weekly += parseCurrency(document.getElementById(`bg_${i}`).value);
            document.getElementById("weeklyBudgetTotal").innerText = formatMoney(weekly) + "ì›";
        }
    }
    function saveBudgets() {
        if(currentBudgetMode === 'week') {
            let w = parseCurrency(document.getElementById('bg_weekday').value);
            let e = parseCurrency(document.getElementById('bg_weekend').value);
            budgets[0]=e; budgets[6]=e; for(let i=1; i<=5; i++) budgets[i]=w;
        } else if (currentBudgetMode === 'all') {
            let val = parseCurrency(document.getElementById('bg_everyday').value);
            for(let i=0; i<7; i++) budgets[i] = val;
        } else {
            for(let i=0; i<7; i++) budgets[i] = parseCurrency(document.getElementById(`bg_${i}`).value);
        }
        saveData(); document.getElementById("budgetOverlay").classList.remove("active");
        document.getElementById('bg_weekday').value = "";
        document.getElementById('bg_weekend').value = "";
        document.getElementById('bg_everyday').value = "";
    }
    function closeBudgetModal(e) { if(e.target.id==="budgetOverlay") document.getElementById("budgetOverlay").classList.remove("active"); }

    // --- ê¸°ì¡´ ë¡œì§ ---
    function updateDashboard() {
        let today = new Date();
        let todayKey = getDateKey(today);
        let futureImpact = 0;
        Object.keys(records).forEach(key => {
            if (key > todayKey) {
                records[key].forEach(r => {
                    if (r.type === 'income' || r.type === 'withdraw_saving') futureImpact += r.amount;
                    else if (r.type === 'expense' || r.type === 'saving') futureImpact -= r.amount;
                });
            }
        });
        let expectedBalance = balance;
        let currentRealBalance = expectedBalance - futureImpact;
        document.getElementById("balanceDisplay").innerText = formatMoney(currentRealBalance) + "ì›";
        document.getElementById("expectedBalanceDisplay").innerText = `(ì˜ˆìƒ ì”ì•¡: ${formatMoney(expectedBalance)}ì›)`;
        let totalRecordedSavings = 0;
        Object.values(records).flat().forEach(r => {
            if(r.type === 'saving') totalRecordedSavings += r.amount;
            if(r.type === 'withdraw_saving') totalRecordedSavings -= r.amount;
        });
        document.getElementById("savingsDisplay").innerText = formatMoney(initialSavings + totalRecordedSavings) + "ì›";
        let startYear = today.getFullYear(), startMonth = today.getMonth();
        if (today.getDate() < payday) startMonth -= 1;
        let accumulatedSaved = 0;
        let loopDate = new Date(startYear, startMonth, payday);
        while(getDateKey(loopDate) <= todayKey) {
            let key = getDateKey(loopDate);
            let dailyBudget = budgets[loopDate.getDay()];
            let dailyVarExp = 0;
            if(records[key]) records[key].forEach(r => {
                if(r.type === 'expense' && r.nature !== 'fixed') dailyVarExp += r.amount;
            });
            accumulatedSaved += (dailyBudget - dailyVarExp);
            loopDate.setDate(loopDate.getDate() + 1);
        }
        let saveEl = document.getElementById("accumulatedSaveDisplay");
        if(accumulatedSaved >= 0) { saveEl.innerText = "+" + formatMoney(accumulatedSaved) + "ì›"; saveEl.className = "info-value val-good"; }
        else { saveEl.innerText = formatMoney(accumulatedSaved) + "ì›"; saveEl.className = "info-value val-bad"; }
    }

    function openForm(mode, record=null) {
        document.getElementById("formOverlay").classList.add("active");
        const typeSelect = document.getElementById("inputType");
        if(record) { 
            document.getElementById("formTitle").innerText = "ë‚´ì—­ ìˆ˜ì •";
            document.getElementById("inputDate").value = targetKey;
            document.getElementById("inputAmount").value = record.amount.toLocaleString();
            document.getElementById("inputMemo").value = record.memo || "";
            typeSelect.value = record.type;
            handleTypeChange();
        } else { 
            isEditing = false;
            document.getElementById("formTitle").innerText = "ë‚´ì—­ ì¶”ê°€";
            document.getElementById("inputDate").value = getDateKey(selectedDate);
            document.getElementById("inputAmount").value = "";
            document.getElementById("inputMemo").value = "";
            typeSelect.value = (mode === 'income') ? 'income' : 'expense';
            handleTypeChange();
        }
    }
    function handleTypeChange() {
        let type = document.getElementById("inputType").value;
        let catRow = document.getElementById("categoryRow");
        let natureSelect = document.getElementById("expenseNature");
        if(type === 'expense') { catRow.classList.remove("hidden"); natureSelect.classList.remove("hidden"); } 
        else { catRow.classList.add("hidden"); natureSelect.classList.add("hidden"); }
    }
    function handleCategoryChange() { document.getElementById("customCategory").classList.toggle("hidden", document.getElementById("inputCategory").value !== "ê¸°íƒ€"); }
    function closeForm(e) { if(e.target.id==="formOverlay") document.getElementById("formOverlay").classList.remove("active"); }
    function saveRecord() {
        let dateVal = document.getElementById("inputDate").value;
        let type = document.getElementById("inputType").value;
        let amount = parseCurrency(document.getElementById("inputAmount").value);
        let memo = document.getElementById("inputMemo").value;
        let nature = "variable"; let category = "-";
        if(!dateVal || amount === 0) { alert("ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”."); return; }
        if(type === 'expense') {
            let catSelect = document.getElementById("inputCategory").value;
            category = (catSelect === 'ê¸°íƒ€') ? (document.getElementById("customCategory").value || 'ê¸°íƒ€') : catSelect;
            nature = document.getElementById("expenseNature").value;
        } else if (type === 'saving') category = 'ì €ì¶•';
        else if (type === 'withdraw_saving') category = 'ì €ì¶• ì¶œê¸ˆ';
        else category = 'ìˆ˜ì…';
        if(isEditing) {
            let oldR = records[targetKey][targetIndex];
            if(oldR.type==='income' || oldR.type==='withdraw_saving') balance -= oldR.amount; else balance += oldR.amount;
            records[targetKey].splice(targetIndex, 1);
            if(records[targetKey].length === 0) delete records[targetKey];
        }
        if(!records[dateVal]) records[dateVal] = [];
        records[dateVal].push({ type, amount, category, memo, nature });
        if(type === 'income' || type === 'withdraw_saving') balance += amount; else balance -= amount;
        saveData();
        document.getElementById("formOverlay").classList.remove("active");
        selectedDate = new Date(dateVal); renderCalendar(); showRecordsForDate(selectedDate);
    }
    function renderCalendar() {
        let year = currentDate.getFullYear(); let month = currentDate.getMonth();
        document.getElementById("monthTitle").innerText = `${year}ë…„ ${month+1}ì›”`;
        let grid = document.getElementById("calendarGrid"); grid.innerHTML = "";
        let firstDay = new Date(year, month, 1).getDay();
        let lastDate = new Date(year, month+1, 0).getDate();
        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement("div"));
        for(let d=1; d<=lastDate; d++){
            let dateObj = new Date(year, month, d);
            let key = getDateKey(dateObj);
            let dayOfWeek = dateObj.getDay();
            let el = document.createElement("div");
            el.className = "day-cell";
            if(key === getDateKey(new Date())) el.classList.add("today");
            if(key === getDateKey(selectedDate)) el.classList.add("selected");
            el.innerHTML = `<div class="day-num" style="color:${dayOfWeek===0?'var(--ios-red)':(dayOfWeek===6?'var(--ios-blue)':'#343a40')}">${d}</div>`;
            let dotsContainer = document.createElement("div");
            dotsContainer.className = "dots-container";
            let dailyExp = 0, hasIncome = false, hasSaving = false;
            if(records[key]) records[key].forEach(r => { 
                if(r.type==='expense' && r.nature!=='fixed') dailyExp+=r.amount; 
                if(r.type==='income' || r.type==='withdraw_saving') hasIncome = true;
                if(r.type==='saving') hasSaving = true;
            });
            if(dailyExp > 0) {
                let limit = budgets[dayOfWeek];
                let dot = document.createElement("div"); dot.className = "status-dot";
                if(dailyExp > limit) dot.classList.add("dot-red"); else if(dailyExp === limit) dot.classList.add("dot-yellow"); else dot.classList.add("dot-green");
                dotsContainer.appendChild(dot);
            }
            if(hasIncome || hasSaving) { let dot = document.createElement("div"); dot.className = "status-dot dot-blue"; dotsContainer.appendChild(dot); }
            el.appendChild(dotsContainer);
            el.onclick = () => { selectedDate = new Date(year, month, d); renderCalendar(); showRecordsForDate(selectedDate); };
            grid.appendChild(el);
        }
    }
    function changeMonth(n) { currentDate.setMonth(currentDate.getMonth()+n); renderCalendar(); }
    function showRecordsForDate(dateObj) {
        let key = getDateKey(dateObj);
        document.getElementById("selectedDateTitle").innerText = `${dateObj.getMonth()+1}ì›” ${dateObj.getDate()}ì¼ ë‚´ì—­`;
        let list = document.getElementById("recordList"); list.innerHTML = "";
        let dayRecords = records[key] || [];
        if(dayRecords.length === 0) { list.innerHTML = `<div style="padding:40px; text-align:center; color:#adb5bd;">ê¸°ë¡ ì—†ìŒ</div>`; return; }
        dayRecords.forEach((r, idx) => {
            let div = document.createElement("div"); div.className = "record-item";
            let amountClass = 'amount-expense'; let sign = '-'; let metaHtml = "";
            if(r.type === 'income') { amountClass='amount-income'; sign='+'; }
            else if(r.type === 'saving') { amountClass='amount-saving'; sign='-'; }
            else if(r.type === 'withdraw_saving') { amountClass='amount-income'; sign='+'; }
            else { if(r.nature === 'fixed') metaHtml += `<span class="tag-fixed">ê³ ì •ë¹„</span>`; }
            if(r.memo) metaHtml += ` <span class="tag-memo">"${r.memo}"</span>`;
            div.innerHTML = `<div class="record-info"><div class="record-cat">${r.category}</div><div class="record-meta">${metaHtml}</div></div><div class="${amountClass}">${sign}${formatMoney(r.amount)}ì›</div>`;
            let timer; const start = () => { timer = setTimeout(() => { openActionSheet(key, idx); }, 600); }; const end = () => clearTimeout(timer);
            div.addEventListener('touchstart', start); div.addEventListener('touchend', end); div.addEventListener('mousedown', start); div.addEventListener('mouseup', end);
            list.appendChild(div);
        });
    }
    function openSettings() { document.getElementById("settingsSheet").classList.add("active"); }
    function closeSettingsReal() { document.getElementById("settingsSheet").classList.remove("active"); }
    function setupLongPress() {
        addLongPressEvent(document.getElementById("boxSavings"), () => {
            document.getElementById("initialSavingsOverlay").classList.add("active");
            document.getElementById("initialSavingsInput").value = initialSavings.toLocaleString();
        });
        addLongPressEvent(document.getElementById("boxSavingGoal"), () => {
            let newPayday = prompt("ê¸°ì¤€ì¼(ì›”ê¸‰ë‚ ) ì…ë ¥ (1~31)", payday);
            if(newPayday) { payday = parseInt(newPayday); saveData(); }
        });
    }
    function addLongPressEvent(el, callback) {
        let timer;
        const start = () => { timer = setTimeout(() => { if(navigator.vibrate) navigator.vibrate(50); callback(); }, 800); };
        const end = () => clearTimeout(timer);
        el.addEventListener('touchstart', start); el.addEventListener('touchend', end); el.addEventListener('mousedown', start); el.addEventListener('mouseup', end);
    }
    function closeInitialSavingsModal(e) { if(e.target.id==="initialSavingsOverlay") document.getElementById("initialSavingsOverlay").classList.remove("active"); }
    function saveInitialSavings() { initialSavings = parseCurrency(document.getElementById("initialSavingsInput").value); saveData(); document.getElementById("initialSavingsOverlay").classList.remove("active"); }
    function openActionSheet(key, index) { targetKey = key; targetIndex = index; document.getElementById("actionSheet").classList.add("active"); }
    function closeActionSheet(e) { if(e.target.id === "actionSheet") document.getElementById("actionSheet").classList.remove("active"); }
    function closeActionSheetReal() { document.getElementById("actionSheet").classList.remove("active"); }
    function executeEdit() { closeActionSheetReal(); isEditing = true; let record = records[targetKey][targetIndex]; openForm(null, record); }
    function executeDelete() {
        if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        let record = records[targetKey][targetIndex];
        if(record.type==='income' || record.type==='withdraw_saving') balance -= record.amount; else balance += record.amount;
        records[targetKey].splice(targetIndex, 1);
        if(records[targetKey].length===0) delete records[targetKey];
        saveData(); closeActionSheetReal(); showRecordsForDate(new Date(targetKey));
    }
    function resetAllData() { if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
