<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ì•„ì´í° ê°€ê³„ë¶€ Final</title>
<style>
    :root {
        --ios-bg: #F2F2F7;
        --ios-card: #FFFFFF;
        --ios-blue: #007AFF;
        --ios-red: #FF3B30;
        --ios-green: #34C759;
        --ios-gray-text: #8E8E93;
        --ios-border: #E5E5EA;
        --ios-black: #000000;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--ios-bg);
        margin: 0; padding: 0; color: var(--ios-black);
        -webkit-font-smoothing: antialiased; user-select: none; padding-bottom: 50px;
    }

    /* --- í—¤ë” --- */
    .header-card {
        background: var(--ios-card); padding: 20px;
        border-bottom-left-radius: 24px; border-bottom-right-radius: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 20px; position: relative;
    }

    /* ì„¤ì • ë²„íŠ¼ */
    .settings-btn {
        position: absolute; top: 20px; right: 20px;
        background: none; border: none; font-size: 22px; cursor: pointer; color: var(--ios-blue);
    }

    .main-balance { text-align: center; margin-bottom: 25px; margin-top: 10px; }
    .header-label { font-size: 14px; color: var(--ios-gray-text); margin-bottom: 6px; }
    .balance-amount { font-size: 38px; font-weight: 700; letter-spacing: -0.5px; }

    /* ì„œë¸Œ ì •ë³´ */
    .sub-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
    .info-box {
        background: #F9F9F9; border-radius: 18px; padding: 15px; text-align: center;
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.03); transition: transform 0.1s; cursor: pointer;
    }
    .info-box:active { transform: scale(0.96); background: #f0f0f0; }
    .info-title { font-size: 12px; color: #888; margin-bottom: 6px; font-weight: 500; }
    .info-value { font-size: 17px; font-weight: 700; }
    
    .val-saving { color: var(--ios-blue); }
    .val-good { color: var(--ios-green); }
    .val-bad { color: var(--ios-red); }

    /* ë²„íŠ¼ ê·¸ë£¹ */
    .action-row { display: flex; gap: 10px; }
    .btn-main {
        flex: 1; padding: 14px; border-radius: 14px; border: none;
        font-size: 15px; font-weight: 600; color: white;
        background: var(--ios-blue); cursor: pointer; transition: opacity 0.2s;
        box-shadow: 0 2px 6px rgba(0,122,255,0.2);
    }
    .btn-main:active { opacity: 0.7; transform: scale(0.98); }
    .btn-income { background: var(--ios-green); box-shadow: 0 2px 6px rgba(52,199,89,0.2); }
    .btn-budget { background: white; color: var(--ios-blue); border: 1px solid var(--ios-blue); box-shadow: none; }

    /* --- ëª¨ë‹¬/í¼ --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.4); display: none; z-index: 1000;
        align-items: center; justify-content: center; backdrop-filter: blur(2px);
    }
    .modal-overlay.active { display: flex; }

    .input-group {
        background: white; width: 85%; max-width: 360px;
        padding: 24px; border-radius: 24px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        animation: popUp 0.25s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes popUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .form-row { margin-bottom: 16px; }
    .form-label { font-size: 13px; font-weight:600; color: #333; margin-bottom: 6px; display: block; }
    input, select {
        width: 100%; box-sizing: border-box; padding: 14px;
        border-radius: 12px; border: 1px solid #E5E5EA;
        font-size: 16px; background: #F2F2F7; -webkit-appearance: none;
    }
    input:focus, select:focus { background: white; border-color: var(--ios-blue); outline: none; }
    
    .hidden { display: none; }

    /* --- ë‹¬ë ¥ --- */
    .calendar-container {
        background: var(--ios-card); margin: 0 16px; border-radius: 20px;
        padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    .cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .cal-title { font-size: 18px; font-weight: 700; }
    .nav-btn { background: none; border: none; font-size: 16px; color: var(--ios-blue); padding: 5px; cursor: pointer;}
    .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: #999; margin-bottom: 10px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    
    .day-cell {
        height: 54px; display: flex; flex-direction: column; align-items: center;
        cursor: pointer; border-radius: 10px; position: relative; padding-top:6px;
    }
    .day-cell.today { background: rgba(0,122,255,0.08); }
    .day-cell.selected { border: 2px solid var(--ios-blue); }
    
    .day-num { font-size: 15px; font-weight: 500; margin-bottom: 4px; }
    .status-dot { width: 5px; height: 5px; border-radius: 50%; }
    .dot-green { background-color: var(--ios-green); }
    .dot-yellow { background-color: #FFCC00; }
    .dot-red { background-color: var(--ios-red); }
    
    .sun { color: var(--ios-red); } .sat { color: var(--ios-blue); }

    /* --- ë¦¬ìŠ¤íŠ¸ --- */
    .detail-section { margin: 24px 16px; }
    .list-header { font-size: 18px; font-weight:700; margin-bottom: 10px; margin-left: 5px; }
    .record-list { background: var(--ios-card); border-radius: 16px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
    .record-item {
        padding: 18px; border-bottom: 1px solid var(--ios-border);
        display: flex; justify-content: space-between; align-items: center;
    }
    .record-item:active { background: #f5f5f5; }
    .record-cat { font-size: 16px; font-weight: 500; margin-bottom: 2px;}
    .record-sub { font-size: 12px; color: #999; }
    .amount-expense { color: var(--ios-black); font-weight:600; font-size: 16px; }
    .amount-income { color: var(--ios-green); font-weight:600; font-size: 16px; }
    .amount-saving { color: var(--ios-blue); font-weight:600; font-size: 16px; }

    /* --- ì•¡ì…˜ ì‹œíŠ¸ --- */
    .action-sheet-overlay {
        position: fixed; top:0; left:0; right:0; bottom:0;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: none; align-items: flex-end;
    }
    .action-sheet-overlay.active { display: flex; }
    .action-sheet {
        background: transparent; width: 100%; padding: 10px;
        box-sizing: border-box;
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    .sheet-btn {
        background: white; border: none; width: 100%; padding: 18px;
        font-size: 17px; color: var(--ios-blue); margin-bottom: 1px; cursor: pointer;
    }
    .sheet-btn:first-child { border-top-left-radius: 14px; border-top-right-radius: 14px; }
    .sheet-btn:last-child { border-bottom-left-radius: 14px; border-bottom-right-radius: 14px; margin-bottom: 8px; }
    .sheet-cancel { border-radius: 14px; font-weight: 600; background: white; }
    .sheet-delete { color: var(--ios-red); }

</style>
</head>
<body>

<div class="header-card">
    <button class="settings-btn" onclick="openSettings()">âš™ï¸</button>
    <div class="main-balance">
        <div class="header-label">í˜„ì¬ ì”ê³ </div>
        <div class="balance-amount" id="balanceDisplay">0ì›</div>
    </div>

    <div class="sub-info-grid">
        <div class="info-box" id="boxSavings">
            <div class="info-title">ğŸ’° ì €ì¶• í†µì¥</div>
            <div class="info-value val-saving" id="savingsDisplay">0ì›</div>
        </div>
        <div class="info-box" id="boxSavingGoal">
            <div class="info-title">ğŸ‘ ì´ë²ˆ ë‹¬ ì•„ë‚€ ëˆ</div>
            <div class="info-value" id="accumulatedSaveDisplay">0ì›</div>
            <div style="font-size:10px; color:#aaa; margin-top:2px;" id="paydayLabel">ë§¤ì›” 1ì¼ ê¸°ì¤€</div>
        </div>
    </div>

    <div class="action-row">
        <button class="btn-main" onclick="openForm('expense')">ì§€ì¶œ ê¸°ë¡</button>
        <button class="btn-main btn-income" onclick="openForm('income')">ìˆ˜ì… ê¸°ë¡</button>
        <button class="btn-main btn-budget" onclick="openBudgetModal()">ì˜ˆì‚° ì„¤ì •</button>
    </div>
</div>

<div class="modal-overlay" id="formOverlay" onclick="closeForm(event)">
    <div class="input-group" id="inputForm">
        <h3 id="formTitle" style="margin:0 0 20px 0;">ë‚´ì—­ ì¶”ê°€</h3>
        
        <div class="form-row">
            <label class="form-label">ë‚ ì§œ</label>
            <input type="date" id="inputDate">
        </div>

        <div class="form-row">
            <label class="form-label">ìœ í˜•</label>
            <select id="inputType" onchange="handleTypeChange()">
                <option value="expense">ì§€ì¶œ</option>
                <option value="saving">ì €ì¶•</option>
                <option value="income">ìˆ˜ì…</option>
            </select>
        </div>

        <div class="form-row" id="categoryRow">
            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
            <select id="inputCategory" onchange="handleCategoryChange()">
                <option value="ì‹ë¹„">ì‹ë¹„</option>
                <option value="êµí†µ">êµí†µ</option>
                <option value="ì‡¼í•‘">ì‡¼í•‘</option>
                <option value="ì£¼ê±°">ì£¼ê±°/í†µì‹ </option>
                <option value="ì˜ë£Œ">ì˜ë£Œ/ê±´ê°•</option>
                <option value="ë¬¸í™”">ë¬¸í™”/ì—¬ê°€</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€ (ì§ì ‘ì…ë ¥)</option>
            </select>
            <input type="text" id="customCategory" class="hidden" placeholder="ì¹´í…Œê³ ë¦¬ëª… ì…ë ¥" style="margin-top:8px;">
        </div>

        <div class="form-row">
            <label class="form-label">ê¸ˆì•¡</label>
            <input type="text" id="inputAmount" placeholder="0" inputmode="numeric" onkeyup="formatCurrencyInput(this)">
        </div>

        <button class="btn-main" style="width:100%" onclick="saveRecord()">ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<div class="modal-overlay" id="budgetOverlay" onclick="closeBudgetModal(event)">
    <div class="input-group">
        <h3 style="margin:0 0 10px 0;">ìš”ì¼ë³„ ì˜ˆì‚°</h3>
        <p style="font-size:13px; color:#888; margin-bottom:20px;">ì¼ìš”ì¼ë¶€í„° í† ìš”ì¼ê¹Œì§€ í•˜ë£¨ ì˜ˆì‚°ì„ ì„¤ì •í•˜ì„¸ìš”.</p>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <div><label class="form-label" style="color:red">ì¼ìš”ì¼</label><input type="text" id="bg_0" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
            <div><label class="form-label">ì›”ìš”ì¼</label><input type="text" id="bg_1" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
            <div><label class="form-label">í™”ìš”ì¼</label><input type="text" id="bg_2" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
            <div><label class="form-label">ìˆ˜ìš”ì¼</label><input type="text" id="bg_3" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
            <div><label class="form-label">ëª©ìš”ì¼</label><input type="text" id="bg_4" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
            <div><label class="form-label">ê¸ˆìš”ì¼</label><input type="text" id="bg_5" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
            <div><label class="form-label" style="color:blue">í† ìš”ì¼</label><input type="text" id="bg_6" inputmode="numeric" onkeyup="formatCurrencyInput(this)"></div>
        </div>
        <button class="btn-main" style="width:100%; margin-top:20px;" onclick="saveBudgets()">ì €ì¥</button>
    </div>
</div>

<div class="action-sheet-overlay" id="settingsSheet" onclick="closeSettings(event)">
    <div class="action-sheet">
        <div style="border-radius:14px; overflow:hidden; margin-bottom:8px;">
            <button class="sheet-btn" style="color:black; font-weight:600;">í™˜ê²½ ì„¤ì •</button>
            <div style="height:1px; background:#E5E5EA;"></div>
            <button class="sheet-btn sheet-delete" onclick="resetAllData()">âš ï¸ ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
        <button class="sheet-btn sheet-cancel" onclick="closeSettingsReal()">ë‹«ê¸°</button>
    </div>
</div>

<div class="action-sheet-overlay" id="actionSheet" onclick="closeActionSheet(event)">
    <div class="action-sheet">
        <div style="border-radius:14px; overflow:hidden; margin-bottom:8px;">
            <button class="sheet-btn" onclick="executeEdit()">ìˆ˜ì •í•˜ê¸°</button>
            <div style="height:1px; background:#E5E5EA;"></div>
            <button class="sheet-btn sheet-delete" onclick="executeDelete()">ì‚­ì œí•˜ê¸°</button>
        </div>
        <button class="sheet-btn sheet-cancel" onclick="closeActionSheetReal()">ì·¨ì†Œ</button>
    </div>
</div>

<div class="calendar-container">
    <div class="cal-nav">
        <button class="nav-btn" onclick="changeMonth(-1)">â—€ ì´ì „</button>
        <div class="cal-title" id="monthTitle"></div>
        <button class="nav-btn" onclick="changeMonth(1)">ë‹¤ìŒ â–¶</button>
    </div>
    <div class="weekdays">
        <div class="sun">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="sat">í† </div>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
</div>

<div class="detail-section">
    <div class="list-header" id="selectedDateTitle">ì˜¤ëŠ˜ì˜ ë‚´ì—­</div>
    <p style="font-size:13px; color:#aaa; margin-left:5px; margin-top:0;">ğŸ’¡ í•­ëª©ì„ ê¸¸ê²Œ ëˆ„ë¥´ë©´ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥</p>
    <div class="record-list" id="recordList"></div>
</div>

<script>
    // --- ì´ˆê¸° ë°ì´í„° ë¡œë“œ ---
    let balance = parseInt(localStorage.getItem("balance")) || 0;
    let savings = parseInt(localStorage.getItem("savings")) || 0;
    let payday = parseInt(localStorage.getItem("payday")) || 1; // ì›”ê¸‰ë‚  (ê¸°ë³¸ 1ì¼)
    let records = JSON.parse(localStorage.getItem("records")) || {};
    let budgets = JSON.parse(localStorage.getItem("dailyBudgets")) || [50000, 30000, 30000, 30000, 30000, 30000, 50000];

    let currentDate = new Date();
    let selectedDate = new Date();
    
    // í¸ì§‘ìš© ì„ì‹œ ë³€ìˆ˜
    let targetKey = null;
    let targetIndex = null;
    let isEditing = false;

    // --- ì´ˆê¸° ì‹¤í–‰ ---
    document.addEventListener("DOMContentLoaded", () => {
        setupLongPress();
        updateDashboard();
        renderCalendar();
        showRecordsForDate(new Date());
    });

    // --- ìœ í‹¸ë¦¬í‹°: ì½¤ë§ˆ í¬ë§·íŒ… ---
    function formatMoney(num) { return num.toLocaleString(); }
    
    // ì…ë ¥ í•„ë“œì—ì„œ ì‹¤ì‹œê°„ ì½¤ë§ˆ ì ìš©
    function formatCurrencyInput(input) {
        let value = input.value.replace(/[^0-9]/g, ''); // ìˆ«ì ë¹¼ê³  ì œê±°
        if (value) {
            input.value = parseInt(value).toLocaleString();
        } else {
            input.value = "";
        }
    }
    
    // ì½¤ë§ˆ ì œê±°í•˜ê³  ìˆ«ìë¡œ ë³€í™˜
    function parseCurrency(str) {
        return parseInt(str.replace(/,/g, '')) || 0;
    }

    function getDateKey(dateObj) {
        const offset = dateObj.getTimezoneOffset() * 60000;
        return (new Date(dateObj - offset)).toISOString().slice(0, 10);
    }
    
    function saveData() {
        localStorage.setItem("balance", balance);
        localStorage.setItem("savings", savings);
        localStorage.setItem("payday", payday);
        localStorage.setItem("records", JSON.stringify(records));
        localStorage.setItem("dailyBudgets", JSON.stringify(budgets));
        updateDashboard();
        renderCalendar();
    }

    // --- ì„¤ì • & ì´ˆê¸°í™” ---
    function openSettings() { document.getElementById("settingsSheet").classList.add("active"); }
    function closeSettings(e) { if(e.target.id === "settingsSheet") closeSettingsReal(); }
    function closeSettingsReal() { document.getElementById("settingsSheet").classList.remove("active"); }
    
    function resetAllData() {
        if(confirm("ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
            localStorage.clear();
            alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        }
    }

    // --- ë¡±í”„ë ˆìŠ¤ ê¸°ëŠ¥ (ì›”ê¸‰ë‚  & ì €ì¶•ìˆ˜ì •) ---
    function setupLongPress() {
        // ì €ì¶• í†µì¥ ë¡±í”„ë ˆìŠ¤
        addLongPressEvent(document.getElementById("boxSavings"), () => {
            let newVal = prompt("ì €ì¶• í†µì¥ì˜ ì‹¤ì œ ì”ì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ìˆ«ìë§Œ)", savings);
            if(newVal !== null) {
                let parsed = parseInt(newVal);
                if(!isNaN(parsed)) {
                    savings = parsed;
                    saveData();
                    alert("ì €ì¶• ì”ì•¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            }
        });

        // ì•„ë‚€ ëˆ(ì›”ê¸‰ë‚ ) ë¡±í”„ë ˆìŠ¤
        addLongPressEvent(document.getElementById("boxSavingGoal"), () => {
            let newPayday = prompt("ì›”ê¸‰ë‚ (ê¸°ì¤€ì¼)ì„ ì…ë ¥í•˜ì„¸ìš” (1~31)", payday);
            if(newPayday !== null) {
                let parsed = parseInt(newPayday);
                if(parsed >= 1 && parsed <= 31) {
                    payday = parsed;
                    saveData();
                    alert(`ê¸°ì¤€ì¼ì´ ë§¤ì›” ${payday}ì¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } else {
                    alert("1ì—ì„œ 31 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                }
            }
        });
    }

    function addLongPressEvent(el, callback) {
        let timer;
        el.addEventListener('touchstart', () => { timer = setTimeout(() => { if(navigator.vibrate) navigator.vibrate(50); callback(); }, 800); });
        el.addEventListener('touchend', () => clearTimeout(timer));
        el.addEventListener('mousedown', () => { timer = setTimeout(callback, 800); });
        el.addEventListener('mouseup', () => clearTimeout(timer));
    }


    // --- ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ (ì›”ê¸‰ë‚  ë¡œì§ ì ìš©) ---
    function updateDashboard() {
        document.getElementById("balanceDisplay").innerText = formatMoney(balance) + "ì›";
        document.getElementById("savingsDisplay").innerText = formatMoney(savings) + "ì›";
        document.getElementById("paydayLabel").innerText = `ë§¤ì›” ${payday}ì¼ ê¸°ì¤€`;

        // ì›”ê¸‰ë‚  ê¸°ì¤€ ê¸°ê°„ ê³„ì‚°
        let today = new Date();
        // ì˜¤ëŠ˜ ë‚ ì§œê°€ ì›”ê¸‰ë‚ ë³´ë‹¤ ì‘ìœ¼ë©´(ì´ì „ì´ë©´), ì‹œì‘ì¼ì€ ì €ë²ˆë‹¬ ì›”ê¸‰ë‚ 
        // ì˜¤ëŠ˜ ë‚ ì§œê°€ ì›”ê¸‰ë‚ ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ìœ¼ë©´, ì‹œì‘ì¼ì€ ì´ë²ˆë‹¬ ì›”ê¸‰ë‚ 
        
        let startYear = today.getFullYear();
        let startMonth = today.getMonth(); // 0-11
        
        if (today.getDate() < payday) {
            startMonth = startMonth - 1; // ì§€ë‚œë‹¬
        }
        
        // ë‚ ì§œ ë£¨í”„: ì‹œì‘ì¼ ~ ì–´ì œê¹Œì§€ (ì˜¤ëŠ˜ì€ ì•„ì§ ì•ˆ ëë‚¬ì§€ë§Œ ì‹¤ì‹œê°„ ë°˜ì˜ì„ ì›í•˜ë©´ ì˜¤ëŠ˜ í¬í•¨)
        // ì—¬ê¸°ì„  "ì˜¤ëŠ˜"ê¹Œì§€ í¬í•¨í•´ì„œ ê³„ì‚°
        let accumulatedSaved = 0;
        let loopDate = new Date(startYear, startMonth, payday);
        
        // ë¬´í•œë£¨í”„ ë°©ì§€ ë° ì˜¤ëŠ˜ê¹Œì§€ë§Œ ê³„ì‚°
        while(loopDate <= today) {
            let key = getDateKey(loopDate);
            let dayOfWeek = loopDate.getDay();
            let dailyBudget = budgets[dayOfWeek];
            
            let dailyExpense = 0;
            if(records[key]){
                records[key].forEach(r => {
                    if(r.type === 'expense') dailyExpense += r.amount;
                });
            }
            
            // ë¯¸ë˜ ì˜ˆì‚°ì€ ë¯¸ë¦¬ ë•¡ê²¨ì˜¤ì§€ ì•ŠìŒ. (ì˜¤ëŠ˜ì´ loopDateë³´ë‹¤ í¬ê±°ë‚˜ ê°™ì„ë•Œë§Œ)
            accumulatedSaved += (dailyBudget - dailyExpense);
            
            // í•˜ë£¨ ì¦ê°€
            loopDate.setDate(loopDate.getDate() + 1);
        }

        let saveEl = document.getElementById("accumulatedSaveDisplay");
        if(accumulatedSaved >= 0) {
            saveEl.innerText = "+" + formatMoney(accumulatedSaved) + "ì›";
            saveEl.className = "info-value val-good";
        } else {
            saveEl.innerText = formatMoney(accumulatedSaved) + "ì›";
            saveEl.className = "info-value val-bad";
        }
    }

    // --- í¼ ê´€ë¦¬ ---
    function openForm(mode, record=null) {
        document.getElementById("formOverlay").classList.add("active");
        const typeSelect = document.getElementById("inputType");
        const catRow = document.getElementById("categoryRow");

        if(record) { // ìˆ˜ì •
            document.getElementById("formTitle").innerText = "ë‚´ì—­ ìˆ˜ì •";
            document.getElementById("inputDate").value = targetKey;
            // ì½¤ë§ˆ ì ìš©í•´ì„œ ê°’ ë„£ê¸°
            document.getElementById("inputAmount").value = record.amount.toLocaleString();
            
            typeSelect.innerHTML = `<option value="expense">ì§€ì¶œ</option><option value="saving">ì €ì¶•</option><option value="income">ìˆ˜ì…</option>`;
            typeSelect.value = record.type;

            if(record.type === 'expense') {
                catRow.classList.remove("hidden");
                const basic = ["ì‹ë¹„","êµí†µ","ì‡¼í•‘","ì£¼ê±°","ì˜ë£Œ","ë¬¸í™”"];
                if(basic.includes(record.category)){
                    document.getElementById("inputCategory").value = record.category;
                    document.getElementById("customCategory").classList.add("hidden");
                } else {
                    document.getElementById("inputCategory").value = "ê¸°íƒ€";
                    document.getElementById("customCategory").classList.remove("hidden");
                    document.getElementById("customCategory").value = record.category;
                }
            } else {
                catRow.classList.add("hidden");
            }
        } else { // ì‹ ê·œ
            isEditing = false;
            document.getElementById("formTitle").innerText = "ë‚´ì—­ ì¶”ê°€";
            document.getElementById("inputDate").valueAsDate = selectedDate;
            document.getElementById("inputAmount").value = "";
            document.getElementById("customCategory").value = "";
            
            typeSelect.innerHTML = "";
            if(mode === 'expense') {
                typeSelect.add(new Option("ì§€ì¶œ", "expense"));
                typeSelect.add(new Option("ì €ì¶•", "saving"));
                catRow.classList.remove("hidden");
            } else {
                typeSelect.add(new Option("ìˆ˜ì…", "income"));
                catRow.classList.add("hidden");
            }
        }
    }

    function handleTypeChange() {
        let type = document.getElementById("inputType").value;
        let catRow = document.getElementById("categoryRow");
        if(type === 'expense') catRow.classList.remove("hidden");
        else catRow.classList.add("hidden");
    }

    function handleCategoryChange() {
        if(document.getElementById("inputCategory").value === "ê¸°íƒ€") {
            document.getElementById("customCategory").classList.remove("hidden");
        } else {
            document.getElementById("customCategory").classList.add("hidden");
        }
    }

    function closeForm(e) { if(e.target.id==="formOverlay") document.getElementById("formOverlay").classList.remove("active"); }
    function closeFormReal() { document.getElementById("formOverlay").classList.remove("active"); }

    function saveRecord() {
        let dateVal = document.getElementById("inputDate").value;
        let type = document.getElementById("inputType").value;
        // ì½¤ë§ˆ ì œê±° í›„ íŒŒì‹±
        let amount = parseCurrency(document.getElementById("inputAmount").value);
        let category = "-";

        if(!dateVal || amount === 0) { alert("ë‚ ì§œì™€ ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”."); return; }

        if(type === 'expense') {
            let catSelect = document.getElementById("inputCategory").value;
            category = (catSelect === 'ê¸°íƒ€') ? (document.getElementById("customCategory").value || 'ê¸°íƒ€') : catSelect;
        } else if(type === 'saving') {
            category = "ì €ì¶•";
        } else {
            category = "ìˆ˜ì…";
        }

        if(isEditing) {
            let oldR = records[targetKey][targetIndex];
            if(oldR.type === 'income') balance -= oldR.amount;
            else if(oldR.type === 'saving') { balance += oldR.amount; savings -= oldR.amount; }
            else balance += oldR.amount; 
            
            records[targetKey].splice(targetIndex, 1);
            if(records[targetKey].length === 0) delete records[targetKey];
        }

        if(!records[dateVal]) records[dateVal] = [];
        records[dateVal].push({ type, amount, category });

        if(type === 'income') balance += amount;
        else if(type === 'saving') { balance -= amount; savings += amount; }
        else balance -= amount; 

        saveData();
        closeFormReal();
        
        selectedDate = new Date(dateVal);
        renderCalendar(); 
        showRecordsForDate(selectedDate);
    }

    // --- ì•¡ì…˜ ì‹œíŠ¸ ---
    function openActionSheet(key, index, record) {
        targetKey = key;
        targetIndex = index;
        document.getElementById("actionSheet").classList.add("active");
    }
    function closeActionSheet(e) { if(e.target.id === "actionSheet") closeActionSheetReal(); }
    function closeActionSheetReal() { document.getElementById("actionSheet").classList.remove("active"); }

    function executeEdit() {
        closeActionSheetReal();
        isEditing = true;
        let record = records[targetKey][targetIndex];
        openForm(null, record);
    }

    function executeDelete() {
        if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì”ê³ ë„ ë³µêµ¬ë©ë‹ˆë‹¤.")) return;
        
        let record = records[targetKey][targetIndex];
        
        if(record.type === 'income') balance -= record.amount;
        else if(record.type === 'saving') { balance += record.amount; savings -= record.amount; }
        else balance += record.amount;

        records[targetKey].splice(targetIndex, 1);
        if(records[targetKey].length === 0) delete records[targetKey];

        saveData();
        closeActionSheetReal();
        showRecordsForDate(new Date(targetKey));
    }

    // --- ì˜ˆì‚° ì„¤ì • ---
    function openBudgetModal() {
        document.getElementById("budgetOverlay").classList.add("active");
        for(let i=0; i<7; i++) {
            // ì½¤ë§ˆ ë„£ì–´ì„œ ë³´ì—¬ì£¼ê¸°
            document.getElementById(`bg_${i}`).value = budgets[i].toLocaleString();
        }
    }
    function closeBudgetModal(e) { if(e.target.id==="budgetOverlay") document.getElementById("budgetOverlay").classList.remove("active"); }
    function saveBudgets() {
        for(let i=0; i<7; i++) {
            // ì½¤ë§ˆ ì œê±° í›„ ì €ì¥
            budgets[i] = parseCurrency(document.getElementById(`bg_${i}`).value);
        }
        saveData();
        document.getElementById("budgetOverlay").classList.remove("active");
        alert("ì˜ˆì‚°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // --- ë‹¬ë ¥ UI ---
    function renderCalendar() {
        let year = currentDate.getFullYear();
        let month = currentDate.getMonth();
        document.getElementById("monthTitle").innerText = `${year}ë…„ ${month+1}ì›”`;
        
        let grid = document.getElementById("calendarGrid");
        grid.innerHTML = "";
        
        let firstDay = new Date(year, month, 1).getDay();
        let lastDate = new Date(year, month+1, 0).getDate();

        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement("div"));

        for(let d=1; d<=lastDate; d++){
            let dateObj = new Date(year, month, d);
            let key = getDateKey(dateObj);
            let dayOfWeek = dateObj.getDay();
            
            let el = document.createElement("div");
            el.className = "day-cell";
            
            let todayKey = getDateKey(new Date());
            if(key === todayKey) el.classList.add("today");
            if(key === getDateKey(selectedDate)) el.classList.add("selected");
            
            el.innerHTML = `<div class="day-num" style="color:${dayOfWeek===0?'var(--ios-red)':(dayOfWeek===6?'var(--ios-blue)':'black')}">${d}</div>`;
            
            let dailyExp = 0;
            if(records[key]) records[key].forEach(r => { if(r.type==='expense') dailyExp+=r.amount; });
            
            if(dailyExp > 0) {
                let limit = budgets[dayOfWeek];
                let dot = document.createElement("div");
                dot.className = "status-dot";
                if(dailyExp > limit) dot.classList.add("dot-red");
                else if(dailyExp === limit) dot.classList.add("dot-yellow");
                else dot.classList.add("dot-green");
                el.appendChild(dot);
            }
            
            el.onclick = () => {
                selectedDate = new Date(year, month, d);
                renderCalendar();
                showRecordsForDate(selectedDate);
            };
            grid.appendChild(el);
        }
    }

    function changeMonth(n) { currentDate.setMonth(currentDate.getMonth()+n); renderCalendar(); }

    function showRecordsForDate(dateObj) {
        let key = getDateKey(dateObj);
        document.getElementById("selectedDateTitle").innerText = `${dateObj.getMonth()+1}ì›” ${dateObj.getDate()}ì¼ ë‚´ì—­`;
        let list = document.getElementById("recordList");
        list.innerHTML = "";
        
        let dayRecords = records[key] || [];
        if(dayRecords.length === 0) {
            list.innerHTML = `<div style="padding:40px; text-align:center; color:#ccc;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            return;
        }

        dayRecords.forEach((r, idx) => {
            let div = document.createElement("div");
            div.className = "record-item";
            
            let amountClass = 'amount-expense';
            let sign = '-';
            let catText = r.category;
            let subText = "ì§€ì¶œ";

            if(r.type === 'income') { amountClass='amount-income'; sign='+'; subText="ìˆ˜ì…"; catText="ìˆ˜ì…"; }
            else if(r.type === 'saving') { amountClass='amount-saving'; sign='-'; subText="ì €ì¶•"; catText="ì €ì¶•"; }
            
            div.innerHTML = `
                <div>
                    <div class="record-cat">${catText}</div>
                    <div class="record-sub">${subText}</div>
                </div>
                <div class="${amountClass}">${sign}${formatMoney(r.amount)}ì›</div>
            `;
            
            addLongPressEvent(div, () => openActionSheet(key, idx, r));
            
            list.appendChild(div);
        });
    }
</script>
</body>
</html>
